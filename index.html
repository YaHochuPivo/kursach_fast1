<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealEstate ‚Äî –í–∏—Ç—Ä–∏–Ω–∞</title>
    <style>
        body { margin:0; font-family: Arial, Helvetica, sans-serif; color:#0f172a; background:#ffffff; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
        .nav { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid #dbeafe; }
        .brand { display:flex; align-items:center; gap:10px; font-weight:700; color:#1e293b; }
        .brand .logo { width:30px; height:30px; display:grid; place-items:center; border-radius:6px; background:#2563eb; color:#fff; font-size:16px; }
        .nav-links { display:flex; align-items:center; gap:10px; }
        .nav-links a { text-decoration:none; color:#1f2937; padding:6px 10px; border-radius:6px; }
        .nav-links a:hover { background:#eff6ff; }
        .btn { display:inline-block; padding:8px 12px; border-radius:6px; text-decoration:none; font-weight:600; border:1px solid #dbeafe; background:#ffffff; color:#1e293b; }
        .btn-primary { background:#2563eb; color:#fff; border-color:#2563eb; }
        .hero { padding:24px 0 16px; display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; align-items:center; }
        .hero h1 { margin:0 0 10px; font-size:28px; line-height:1.2; color:#0f172a; }
        .hero p { margin:0 0 14px; color:#475569; font-size:14px; }
        .hero-cta { display:flex; gap:8px; flex-wrap:wrap; }
        .hero-card { background:#ffffff; border:1px solid #dbeafe; border-radius:8px; padding:12px; display:grid; gap:8px; }
        .features { padding:10px 0 30px; display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
        .feature { background:#ffffff; border:1px solid #e2e8f0; border-radius:8px; padding:12px; }
        .feature h3 { margin:0 0 6px; font-size:16px; }
        .feature p { margin:0; color:#64748b; font-size:13px; }
        .search input, .search select { padding:10px 8px; border:1px solid #e2e8f0; border-radius:6px; }
        .carousel { display:flex; gap:10px; overflow-x:auto; padding-bottom:8px; }
        .carousel::-webkit-scrollbar { height:8px; }
        .carousel::-webkit-scrollbar-thumb { background:#bfdbfe; border-radius:8px; }
        .card { min-width:260px; background:#fff; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden; position:relative; }
        .media { position:relative; width:260px; height:150px; background:#e2e8f0; overflow:hidden; display:block; }
        .media img { width:100%; height:100%; object-fit:cover; transition: transform .25s ease; display:block; }
        .card:hover .media img { transform: scale(1.03); }
        .meta { position:absolute; inset:auto 0 0 0; padding:8px 10px; background: linear-gradient(to top, rgba(15,23,42,.70), rgba(15,23,42,.0)); color:#fff; display:grid; gap:3px; }
        .meta .title { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .meta .spec { font-size:12px; opacity:.95; }
        .meta .price { font-weight:800; font-size:14px; }
        .card-body { padding:10px 12px; display:grid; gap:6px; }
        .card-title { font-weight:700; color:#1f2937; }
        .card-sub { color:#64748b; font-size:13px; }
        .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#eff6ff; color:#1d4ed8; font-size:12px; }
        .pill.promoted { background:#fef3c7; color:#92400e; }
        .author-info { font-size:11px; color:#64748b; margin-top:4px; display:flex; align-items:center; gap:4px; }
        .author-info .author-name { font-weight:600; color:#334155; }
        .author-info .author-badge { padding:2px 6px; border-radius:4px; background:#dbeafe; color:#1e40af; font-size:10px; }
        .admin-actions { display:flex; gap:4px; margin-top:6px; position:relative; z-index:2; flex-wrap:wrap; }
        .favorite-btn { position:absolute; top:8px; right:8px; width:28px; height:28px; border-radius:50%; background:rgba(255,255,255,.9); border:none; cursor:pointer; display:grid; place-items:center; font-size:16px; z-index:2; }
        .favorite-btn.added { background:#fecaca; }
        .card-link { position:absolute; inset:0; z-index:1; pointer-events:auto; }
        .btn-xs { padding:4px 8px; border-radius:6px; border:1px solid #e2e8f0; background:#fff; color:#334155; font-size:11px; cursor:pointer; white-space:nowrap; flex-shrink:0; }
        .modal .favorite-btn, .modal .admin-actions, .modal .promoted-btn { display:none !important; }
        .btn-xs.danger { border-color:#fecaca; color:#b91c1c; }
        .btn-xs.promoted-btn { border-color:#fbbf24; background:#fef3c7; color:#92400e; }
        .fab-add { position: fixed; right: 16px; bottom: 16px; padding: 10px 14px; border-radius: 999px; background: #2563eb; color:#fff; border:none; cursor:pointer; }
        .modal { position: fixed; inset:0; background: rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:10000; overflow-y:auto; padding:20px; }
        .modal.open { display:flex; }
        .modal-card { width: 720px; max-width: calc(100% - 24px); background:#fff; border-radius:8px; border:1px solid #e2e8f0; overflow:hidden; position:relative; z-index:10001; isolation:isolate; max-height: calc(100vh - 40px); display:flex; flex-direction:column; }
        .modal-body { overflow-y:auto; flex:1; padding:12px; max-height: calc(100vh - 200px); display:grid; gap:8px; grid-template-columns: repeat(2, 1fr); }
        .modal-head { padding:10px 12px; background:#eff6ff; font-weight:700; color:#334155; display:flex; justify-content:space-between; align-items:center; }
        .modal-head button { padding:4px 8px; border-radius:6px; border:1px solid #e2e8f0; background:#fff; color:#334155; font-size:12px; cursor:pointer; white-space:nowrap; }
        .modal-body .full { grid-column: 1 / -1; }
        .modal-body label { display:block; font-size:12px; color:#64748b; margin-bottom:6px; }
        .modal-body input, .modal-body select, .modal-body textarea { width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:6px; box-sizing:border-box; }
        .modal-body .favorite-btn, .modal-body .admin-actions, .modal-body .promoted-btn, .modal .card, .modal .favorite-btn, .modal .admin-actions { display:none !important; }
        .modal-foot { padding:10px 12px; display:flex; gap:10px; justify-content:flex-end; background:#fafafa; border-top:1px solid #e2e8f0; }
        .btn-primary-sm { padding:8px 12px; border:none; border-radius:6px; background:#2563eb; color:#fff; cursor:pointer; }
        .btn-secondary-sm { padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; background:#fff; color:#334155; cursor:pointer; }
        .error-text { color:#b91c1c; font-size:12px; margin-top:4px; }
        .toasts { position: fixed; right: 16px; top: 16px; display:grid; gap:8px; z-index: 9999; }
        .toast { padding:10px 12px; border-radius:6px; background:#fff; border:1px solid #e2e8f0; color:#111827; }
        .toast.success { border-color:#bbf7d0; background:#f0fdf4; color:#14532d; }
        .toast.error { border-color:#fecaca; background:#fff1f2; color:#7f1d1d; }
        .auth-modal { position: fixed; inset:0; background: rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:10000; }
        .auth-modal.open { display:flex; }
        .auth-modal-card { background:#fff; border-radius:8px; border:1px solid #e2e8f0; padding:24px; max-width:400px; width:calc(100% - 32px); }
        .auth-modal-card h3 { margin:0 0 12px; font-size:18px; color:#0f172a; }
        .auth-modal-card p { margin:0 0 16px; color:#64748b; font-size:14px; }
        .auth-modal-card .actions { display:flex; gap:10px; }
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ */
        .property-view-modal { position: fixed; inset:0; background: rgba(15,23,42,.7); display:none; align-items:center; justify-content:center; z-index:10000; overflow-y:auto; padding:20px; }
        .property-view-modal.open { display:flex; }
        .property-view-card { width: 900px; max-width: calc(100% - 40px); background:#fff; border-radius:8px; border:1px solid #e2e8f0; overflow:hidden; position:relative; margin:auto; }
        .property-view-gallery { width:100%; background:#eff6ff; display:flex; gap:8px; overflow:auto; padding:8px; border-bottom:1px solid #dbeafe; }
        .property-view-gallery img { height:320px; border-radius:6px; object-fit:cover; flex-shrink:0; }
        .property-view-gallery.single { justify-content:center; }
        .property-view-gallery.single img { width:100%; height:auto; max-height:520px; }
        .property-view-content { padding:20px; }
        .property-view-title { font-size:24px; font-weight:700; margin:0 0 12px; color:#0f172a; }
        .property-view-price { font-size:20px; font-weight:700; color:#0f172a; margin:0 0 20px; }
        .property-view-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin:20px 0; }
        .property-view-row { background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:12px; }
        .property-view-label { color:#475569; font-size:13px; margin-bottom:4px; }
        .property-view-value { color:#0f172a; font-weight:600; font-size:14px; }
        .property-view-description { background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:12px; margin:20px 0; }
        .property-view-author { font-size:14px; color:#64748b; margin-top:16px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; display:flex; align-items:center; gap:8px; }
        .property-view-author-name { font-weight:600; color:#334155; }
        .property-view-author-badge { padding:3px 8px; border-radius:4px; background:#dbeafe; color:#1e40af; font-size:11px; }
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .property-view-key-features { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin:20px 0; }
        .property-view-key-feature { display:flex; align-items:center; gap:8px; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; }
        .property-view-key-feature-icon { font-size:20px; }
        .property-view-key-feature-text { display:flex; flex-direction:column; }
        .property-view-key-feature-label { font-size:11px; color:#64748b; }
        .property-view-key-feature-value { font-size:14px; font-weight:600; color:#0f172a; }
        .property-view-section { margin:24px 0; }
        .property-view-section-title { font-size:18px; font-weight:700; color:#0f172a; margin:0 0 16px; }
        .property-view-section-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
        .property-view-utilities { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin:16px 0; }
        .property-view-utility { display:flex; justify-content:space-between; padding:8px 12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; }
        .property-view-utility-label { font-size:13px; color:#475569; }
        .property-view-utility-value { font-size:13px; font-weight:600; color:#0f172a; }
        .property-view-amenities { display:flex; flex-wrap:wrap; gap:6px; margin:12px 0; }
        .property-view-amenity { padding:6px 12px; background:#eff6ff; color:#1e40af; border-radius:999px; font-size:12px; }
        .property-view-actions { display:flex; gap:8px; margin-top:20px; flex-wrap:wrap; }
        .property-view-close { position:absolute; top:12px; right:12px; width:32px; height:32px; border-radius:50%; background:#fff; border:1px solid #e2e8f0; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; color:#64748b; z-index:10; }
        .property-view-close:hover { background:#f8fafc; }
        .property-view-chat-btn { padding:10px 20px; border-radius:6px; background:#2563eb; color:#fff; border:none; cursor:pointer; font-size:14px; margin-top:12px; }
        .property-view-chat-btn:hover { background:#1e40af; }
        .chats-badge { display:inline-block; min-width:18px; height:18px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:11px; font-weight:700; line-height:18px; text-align:center; margin-left:6px; }
        @media (max-width: 980px) { .hero { grid-template-columns: 1fr; } .features { grid-template-columns: 1fr; } .property-view-grid { grid-template-columns: 1fr; } }
        .chat-modal { position: fixed; inset:0; background: rgba(15,23,42,.7); display:none; align-items:center; justify-content:center; z-index:11000; overflow-y:auto; padding:20px; }
        .chat-modal.open { display:flex; }
        .chat-modal-card { width: 600px; max-width: calc(100% - 40px); max-height: calc(100vh - 40px); background:#fff; border-radius:8px; border:1px solid #e2e8f0; overflow:hidden; position:relative; display:flex; flex-direction:column; }
        .chat-modal-header { padding:16px 20px; background:#eff6ff; border-bottom:1px solid #dbeafe; display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
        .chat-modal-header-left { flex:1; }
        .chat-modal-header h3 { margin:0 0 4px; font-size:16px; font-weight:700; color:#0f172a; line-height:1.4; }
        .chat-modal-header .property-link { color:#2563eb; text-decoration:none; font-weight:600; border-bottom:1px dotted #2563eb; cursor:pointer; font-size:14px; }
        .chat-modal-header .property-link:hover { color:#1e40af; }
        .chat-modal-header .chat-user-info { font-size:12px; color:#64748b; margin-top:4px; }
        .chat-modal-close { width:28px; height:28px; border-radius:50%; background:#fff; border:1px solid #e2e8f0; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; color:#64748b; flex-shrink:0; }
        .chat-modal-close:hover { background:#f8fafc; }
        .chat-modal-messages { flex:1; overflow-y:auto; padding:16px; background:#f8fafc; min-height:300px; max-height:400px; }
        .chat-modal-message { margin-bottom:12px; display:flex; gap:10px; }
        .chat-modal-message.own { flex-direction:row-reverse; }
        .chat-modal-message-avatar { width:32px; height:32px; border-radius:50%; background:#2563eb; color:#fff; display:grid; place-items:center; font-weight:600; font-size:12px; flex-shrink:0; }
        .chat-modal-message-content { flex:1; max-width:70%; }
        .chat-modal-message-bubble { padding:8px 12px; border-radius:12px; background:#fff; border:1px solid #e2e8f0; }
        .chat-modal-message.own .chat-modal-message-bubble { background:#2563eb; color:#fff; border-color:#2563eb; }
        .chat-modal-message-text { margin:0; font-size:14px; word-wrap:break-word; line-height:1.4; }
        .chat-modal-message-time { font-size:11px; color:#94a3b8; margin-top:4px; }
        .chat-modal-message.own .chat-modal-message-time { text-align:right; }
        .chat-modal-input-area { padding:12px 16px; background:#fff; border-top:1px solid #e2e8f0; display:flex; gap:8px; }
        .chat-modal-input-area input { flex:1; padding:10px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:14px; }
        .chat-modal-input-area button { padding:10px 20px; border:none; border-radius:6px; background:#2563eb; color:#fff; cursor:pointer; font-weight:600; font-size:14px; }
        .chat-modal-input-area button:hover { background:#1e40af; }
        .chat-modal-input-area button:disabled { background:#94a3b8; cursor:not-allowed; }
        .chat-modal-empty { text-align:center; color:#64748b; padding:40px 20px; font-size:14px; }
    </style>
</head>
<body>
        <!-- Hidden element for current user email -->
        <span id="current-user-email" th:if="${currentUserEmail != null}" th:text="${currentUserEmail}" style="display:none;"></span>
    <header class="container nav">
        <div class="brand">
            <div class="logo">üè†</div>
            <div>RealEstate</div>
        </div>
        <div class="nav-links">
            <a th:href="@{/}">–ì–ª–∞–≤–Ω–∞—è</a>
            <a th:href="@{/properties}">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</a>
            <a th:href="@{/user/properties}" class="btn" sec:authorize="isAuthenticated()">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a th:href="@{/user/favorites}" class="btn" sec:authorize="!hasRole('ROLE_ADMIN')">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ ‚ù§Ô∏è</a>
            <a th:href="@{/deals}" class="btn" sec:authorize="isAuthenticated()">–ú–æ–∏ —Å–¥–µ–ª–∫–∏</a>
            <a th:href="@{/chats}" class="btn" sec:authorize="isAuthenticated()" id="chats-link">
                –ß–∞—Ç—ã üí¨
                <span id="chats-badge" class="chats-badge" style="display:none;">0</span>
            </a>
            <a th:href="@{/reports}" class="btn" sec:authorize="isAuthenticated()">–û—Ç—á–µ—Ç—ã</a>
            <a th:href="@{/user/profile}" class="btn" sec:authorize="isAuthenticated()">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a th:href="@{/login}" class="btn" sec:authorize="isAnonymous()">–í–æ–π—Ç–∏</a>
            <a th:href="@{/logout}" class="btn" sec:authorize="isAuthenticated()">–í—ã–π—Ç–∏</a>
            <a th:href="@{/register}" class="btn btn-primary" sec:authorize="isAnonymous()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
        </div>
    </header>

    <main class="container">

        <section style="margin: 6px 0 20px;">
            <form th:action="@{/properties}" method="get" class="search" style="display:grid; grid-template-columns: 220px 160px 160px 140px 160px 1fr 120px; gap:8px;">
                <select name="type">
                    <option value="–∫–≤–∞—Ä—Ç–∏—Ä–∞">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
                    <option value="–¥–æ–º">–î–æ–º</option>
                    <option value="–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è</option>
                </select>
                <select name="rooms">
                    <option value="">–ö–æ–º–Ω–∞—Ç</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4+</option>
                </select>
                <select name="category">
                    <option value="">–¢–∏–ø —Ä—ã–Ω–∫–∞</option>
                    <option value="–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞">–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞</option>
                    <option value="–í—Ç–æ—Ä–∏—á–∫–∞">–í—Ç–æ—Ä–∏—á–∫–∞</option>
                </select>
                <input name="priceMin" placeholder="–¶–µ–Ω–∞ –æ—Ç" />
                <input name="priceMax" placeholder="–¶–µ–Ω–∞ –¥–æ" />
                <input name="q" placeholder="–ì–æ—Ä–æ–¥, –∞–¥—Ä–µ—Å –∏–ª–∏ —Ä–∞–π–æ–Ω" />
                <button class="btn btn-primary" type="submit">–ù–∞–π—Ç–∏</button>
    </form>
        </section>

        <style>
            .section-title { margin:0 0 10px; font-size:18px; color:#0f172a; }
        </style>

        <section style="margin: 18px 0;">
            <h2 class="section-title">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ</h2>
            <div class="carousel">
                <div class="card" th:each="p : ${popular}">
                    <div class="media">
                        <img alt="card" th:src="${p.firstImageUrl != null and !p.firstImageUrl.trim().isEmpty() ? p.firstImageUrl : 'https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop'}" 
                             onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop';" 
                             loading="lazy"/>
                        <button class="favorite-btn" th:onclick="|toggleFavorite(${p.id}, this); event.stopPropagation(); event.preventDefault(); return false;|" sec:authorize="isAnonymous() or (isAuthenticated() and !hasRole('ROLE_ADMIN'))" th:attr="data-property-id=${p.id}">‚ù§Ô∏è</button>
                        <div class="meta">
                            <div class="title" th:text="${p != null and p.titleForCard != null ? p.titleForCard : '–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'}">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                            <div class="spec" th:text="${p.type == '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' ? (p.area != null ? p.area : '-') + ' –º¬≤ ¬∑ ' + (p.floor != null ? p.floor : '-') + ' / ' + (p.floorsTotal != null ? p.floorsTotal : '-') : (p.rooms != null ? p.rooms : '-') + ' –∫–æ–º–Ω ¬∑ ' + (p.area != null ? p.area : '-') + ' –º¬≤ ¬∑ ' + (p.floor != null ? p.floor : '-') + ' / ' + (p.floorsTotal != null ? p.floorsTotal : '-')}">—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</div>
                            <div class="price" th:text="${p.price != null ? (#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ') : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}">–¶–µ–Ω–∞</div>
                        </div>
                    </div>
                    <div class="card-link" th:onclick="|openPropertyView(${p.id}); return false;|" style="cursor:pointer;"></div>
                    <div class="card-body">
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <span class="pill" th:text="${p.category}">–∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                            <span class="pill promoted" th:if="${p.promoted}">–õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</span>
                        </div>
                        <div class="author-info" th:if="${p != null and p.user != null}">
                            <span>–ê–≤—Ç–æ—Ä:</span>
                            <span class="author-name" th:text="${p.user.email != null ? p.user.email : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                            <span class="author-badge" th:if="${p.realtor != null}">–†–∏–µ–ª—Ç–æ—Ä</span>
                        </div>
                        <div class="admin-actions" sec:authorize="isAuthenticated()"
                             th:attr="data-id=${p.id}, data-type=${p.type}, data-category=${p.category}, data-address=${p.address}, data-city=${p.city}, data-district=${p.district}, data-area=${p.area}, data-rooms=${p.rooms}, data-floor=${p.floor}, data-floors=${p.floorsTotal}, data-price=${p.price}, data-imageUrls=${p.imageUrls}, data-description=${p.description}, data-promoted=${p.promoted}">
                            <button class="btn-xs" onclick="openPropertyModal(this); event.stopPropagation(); return false;" 
                                    sec:authorize="hasRole('ROLE_ADMIN')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn-xs" onclick="openPropertyModal(this); event.stopPropagation(); return false;" 
                                    th:if="${p != null and p.user != null and p.user.email != null and #httpServletRequest != null and #httpServletRequest.userPrincipal != null and #httpServletRequest.userPrincipal.name == p.user.email}" 
                                    sec:authorize="!hasRole('ROLE_ADMIN')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn-xs danger" onclick="deleteProperty(this); event.stopPropagation(); return false;" 
                                    sec:authorize="hasRole('ROLE_ADMIN')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn-xs danger" onclick="deleteProperty(this); event.stopPropagation(); return false;" 
                                    th:if="${p != null and p.user != null and p.user.email != null and #httpServletRequest != null and #httpServletRequest.userPrincipal != null and #httpServletRequest.userPrincipal.name == p.user.email}" 
                                    sec:authorize="!hasRole('ROLE_ADMIN')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn-xs" th:classappend="${p.promoted} ? 'promoted-btn' : ''" th:onclick="|togglePromote(${p.id}, this); event.stopPropagation(); return false;|" th:text="${p.promoted} ? '–°–Ω—è—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ' : '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å'" 
                                    th:if="${p != null and p.user != null and p.user.email != null and currentUserEmail != null and (p.user.email == currentUserEmail or (isCurrentUserAdmin != null and isCurrentUserAdmin == true))}" 
                                    sec:authorize="isAuthenticated()">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section style="margin: 18px 0;">
            <h2 class="section-title">–ù–æ–≤–∏–Ω–∫–∏</h2>
            <div class="carousel">
                <div class="card" th:each="p : ${latest}">
                    <div class="media">
                        <img alt="card" th:src="${p.firstImageUrl != null ? p.firstImageUrl : 'https://images.unsplash.com/photo-1600607687920-4ce9ce5f56f6?q=80&w=1200&auto=format&fit=crop'}"/>
                        <button class="favorite-btn" th:onclick="|toggleFavorite(${p.id}, this); event.stopPropagation(); event.preventDefault(); return false;|" sec:authorize="isAnonymous() or (isAuthenticated() and !hasRole('ROLE_ADMIN'))" th:attr="data-property-id=${p.id}">‚ù§Ô∏è</button>
                        <div class="meta">
                            <div class="title" th:text="${p != null and p.titleForCard != null ? p.titleForCard : '–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'}">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                            <div class="spec" th:text="${p.type == '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' ? (p.area != null ? p.area : '-') + ' –º¬≤ ¬∑ ' + (p.floor != null ? p.floor : '-') + ' / ' + (p.floorsTotal != null ? p.floorsTotal : '-') : (p.rooms != null ? p.rooms : '-') + ' –∫–æ–º–Ω ¬∑ ' + (p.area != null ? p.area : '-') + ' –º¬≤ ¬∑ ' + (p.floor != null ? p.floor : '-') + ' / ' + (p.floorsTotal != null ? p.floorsTotal : '-')}">—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</div>
                            <div class="price" th:text="${p.price != null ? (#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ') : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}">–¶–µ–Ω–∞</div>
                        </div>
                    </div>
                    <div class="card-link" th:onclick="|openPropertyView(${p.id}); return false;|" style="cursor:pointer;"></div>
                    <div class="card-body">
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <span class="pill" th:text="${p.category}">–∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                            <span class="pill promoted" th:if="${p.promoted}">–õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</span>
                        </div>
                        <div class="author-info" th:if="${p != null and p.user != null}">
                            <span>–ê–≤—Ç–æ—Ä:</span>
                            <span class="author-name" th:text="${p.user.email != null ? p.user.email : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                            <span class="author-badge" th:if="${p.realtor != null}">–†–∏–µ–ª—Ç–æ—Ä</span>
                        </div>
                        <div class="admin-actions" sec:authorize="isAuthenticated()"
                             th:attr="data-id=${p.id}, data-type=${p.type}, data-category=${p.category}, data-address=${p.address}, data-city=${p.city}, data-district=${p.district}, data-area=${p.area}, data-rooms=${p.rooms}, data-floor=${p.floor}, data-floors=${p.floorsTotal}, data-price=${p.price}, data-imageUrls=${p.imageUrls}, data-description=${p.description}, data-promoted=${p.promoted}">
                            <button class="btn-xs" onclick="openPropertyModal(this); event.stopPropagation(); return false;" 
                                    sec:authorize="hasRole('ROLE_ADMIN')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn-xs" onclick="openPropertyModal(this); event.stopPropagation(); return false;" 
                                    th:if="${p != null and p.user != null and p.user.email != null and #httpServletRequest != null and #httpServletRequest.userPrincipal != null and #httpServletRequest.userPrincipal.name == p.user.email}" 
                                    sec:authorize="!hasRole('ROLE_ADMIN')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn-xs danger" onclick="deleteProperty(this); event.stopPropagation(); return false;" 
                                    sec:authorize="hasRole('ROLE_ADMIN')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn-xs danger" onclick="deleteProperty(this); event.stopPropagation(); return false;" 
                                    th:if="${p != null and p.user != null and p.user.email != null and #httpServletRequest != null and #httpServletRequest.userPrincipal != null and #httpServletRequest.userPrincipal.name == p.user.email}" 
                                    sec:authorize="!hasRole('ROLE_ADMIN')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn-xs" th:classappend="${p.promoted} ? 'promoted-btn' : ''" th:onclick="|togglePromote(${p.id}, this); event.stopPropagation(); return false;|" th:text="${p.promoted} ? '–°–Ω—è—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ' : '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å'" 
                                    th:if="${p != null and p.user != null and p.user.email != null and currentUserEmail != null and (p.user.email == currentUserEmail or (isCurrentUserAdmin != null and isCurrentUserAdmin == true))}" 
                                    sec:authorize="isAuthenticated()">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section style="margin: 18px 0 30px;">
            <h2 class="section-title">–ú–æ–≥—É—Ç –ø–æ–¥–æ–π—Ç–∏</h2>
            <div class="carousel">
                <div class="card" th:each="p : ${affordable}">
                    <div class="media">
                        <img alt="card" th:src="${p.firstImageUrl != null ? p.firstImageUrl : 'https://images.unsplash.com/photo-1560520653-9e0e4c89eb11?q=80&w=1200&auto=format&fit=crop'}"/>
                        <button class="favorite-btn" th:onclick="|toggleFavorite(${p.id}, this); event.stopPropagation(); event.preventDefault(); return false;|" sec:authorize="isAnonymous() or (isAuthenticated() and !hasRole('ROLE_ADMIN'))" th:attr="data-property-id=${p.id}">‚ù§Ô∏è</button>
                        <div class="meta">
                            <div class="title" th:text="${p != null and p.titleForCard != null ? p.titleForCard : '–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'}">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                            <div class="spec" th:text="${p.type == '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' ? (p.area != null ? p.area : '-') + ' –º¬≤ ¬∑ ' + (p.floor != null ? p.floor : '-') + ' / ' + (p.floorsTotal != null ? p.floorsTotal : '-') : (p.rooms != null ? p.rooms : '-') + ' –∫–æ–º–Ω ¬∑ ' + (p.area != null ? p.area : '-') + ' –º¬≤ ¬∑ ' + (p.floor != null ? p.floor : '-') + ' / ' + (p.floorsTotal != null ? p.floorsTotal : '-')}">—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</div>
                            <div class="price" th:text="${p.price != null ? (#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ') : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}">–¶–µ–Ω–∞</div>
                        </div>
                    </div>
                    <div class="card-link" th:onclick="|openPropertyView(${p.id}); return false;|" style="cursor:pointer;"></div>
                    <div class="card-body">
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <span class="pill" th:text="${p.category}">–∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                            <span class="pill promoted" th:if="${p.promoted}">–õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</span>
                        </div>
                        <div class="author-info" th:if="${p != null and p.user != null}">
                            <span>–ê–≤—Ç–æ—Ä:</span>
                            <span class="author-name" th:text="${p.user.email != null ? p.user.email : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                            <span class="author-badge" th:if="${p.realtor != null}">–†–∏–µ–ª—Ç–æ—Ä</span>
                        </div>
                        <div class="admin-actions" sec:authorize="isAuthenticated()"
                             th:attr="data-id=${p.id}, data-type=${p.type}, data-category=${p.category}, data-address=${p.address}, data-city=${p.city}, data-district=${p.district}, data-area=${p.area}, data-rooms=${p.rooms}, data-floor=${p.floor}, data-floors=${p.floorsTotal}, data-price=${p.price}, data-imageUrls=${p.imageUrls}, data-description=${p.description}, data-promoted=${p.promoted}">
                            <button class="btn-xs" onclick="openPropertyModal(this); event.stopPropagation(); return false;" 
                                    sec:authorize="hasRole('ROLE_ADMIN')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn-xs" onclick="openPropertyModal(this); event.stopPropagation(); return false;" 
                                    th:if="${p != null and p.user != null and p.user.email != null and #httpServletRequest != null and #httpServletRequest.userPrincipal != null and #httpServletRequest.userPrincipal.name == p.user.email}" 
                                    sec:authorize="!hasRole('ROLE_ADMIN')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="btn-xs danger" onclick="deleteProperty(this); event.stopPropagation(); return false;" 
                                    sec:authorize="hasRole('ROLE_ADMIN')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn-xs danger" onclick="deleteProperty(this); event.stopPropagation(); return false;" 
                                    th:if="${p != null and p.user != null and p.user.email != null and #httpServletRequest != null and #httpServletRequest.userPrincipal != null and #httpServletRequest.userPrincipal.name == p.user.email}" 
                                    sec:authorize="!hasRole('ROLE_ADMIN')">–£–¥–∞–ª–∏—Ç—å</button>
                            <button class="btn-xs" th:classappend="${p.promoted} ? 'promoted-btn' : ''" th:onclick="|togglePromote(${p.id}, this); event.stopPropagation(); return false;|" th:text="${p.promoted} ? '–°–Ω—è—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ' : '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å'" 
                                    th:if="${p != null and p.user != null and p.user.email != null and currentUserEmail != null and (p.user.email == currentUserEmail or (isCurrentUserAdmin != null and isCurrentUserAdmin == true))}" 
                                    sec:authorize="isAuthenticated()">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- –ù–µ–¥–∞–≤–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π) -->
        <section th:if="${recentViewed != null and !recentViewed.isEmpty()}" style="margin: 18px 0 30px;" sec:authorize="isAuthenticated()">
            <h2 class="section-title">–ù–µ–¥–∞–≤–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ</h2>
            <div class="carousel">
                <div class="card" th:each="p : ${recentViewed}">
                    <div class="media">
                        <img alt="card" th:src="${p.firstImageUrl != null ? p.firstImageUrl : 'https://images.unsplash.com/photo-1560520653-9e0e4c89eb11?q=80&w=1200&auto=format&fit=crop'}" 
                             loading="lazy"/>
                        <button class="favorite-btn" th:onclick="|toggleFavorite(${p.id}, this); event.stopPropagation(); event.preventDefault(); return false;|" sec:authorize="!hasRole('ROLE_ADMIN')" th:attr="data-property-id=${p.id}">‚ù§Ô∏è</button>
                        <div class="meta">
                            <div class="title" th:text="${p != null and p.titleForCard != null ? p.titleForCard : '–û–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏'}">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                            <div class="spec" th:text="${p.type == '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' ? (p.area != null ? p.area : '-') + ' –º¬≤ ¬∑ ' + (p.floor != null ? p.floor : '-') + ' / ' + (p.floorsTotal != null ? p.floorsTotal : '-') : (p.rooms != null ? p.rooms : '-') + ' –∫–æ–º–Ω ¬∑ ' + (p.area != null ? p.area : '-') + ' –º¬≤ ¬∑ ' + (p.floor != null ? p.floor : '-') + ' / ' + (p.floorsTotal != null ? p.floorsTotal : '-')}">—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</div>
                            <div class="price" th:text="${p.price != null ? (#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ') : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}">–¶–µ–Ω–∞</div>
                        </div>
                    </div>
                    <div class="card-link" th:onclick="|openPropertyView(${p.id}); return false;|" style="cursor:pointer;"></div>
                    <div class="card-body">
                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                            <span class="pill" th:text="${p.category}">–∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                            <span class="pill promoted" th:if="${p.promoted}">–õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</span>
                        </div>
                        <div class="author-info" th:if="${p != null and p.user != null}">
                            <span>–ê–≤—Ç–æ—Ä:</span>
                            <span class="author-name" th:text="${p.user.email != null ? p.user.email : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                            <span class="author-badge" th:if="${p.realtor != null}">–†–∏–µ–ª—Ç–æ—Ä</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    <button class="fab-add" sec:authorize="isAuthenticated()" onclick="openPropertyModal(null)">+ –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>

    <div id="prop-modal" class="modal" sec:authorize="isAuthenticated()">
            <div class="modal-card">
                <div class="modal-head">
                    <span id="prop-modal-title">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</span>
                    <button class="btn-secondary-sm" onclick="closePropertyModal()" style="padding:4px 8px; font-size:12px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="f-id" />
                    <div>
                        <label>–¢–∏–ø</label>
                        <select id="f-type">
                            <option value="–∫–≤–∞—Ä—Ç–∏—Ä–∞">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
                            <option value="–¥–æ–º">–î–æ–º</option>
                            <option value="–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è</option>
                        </select>
                        <div id="e-type" class="error-text" style="display:none"></div>
                    </div>
                    <div>
                        <label>–†—ã–Ω–æ–∫</label>
                        <select id="f-category">
                            <option value="–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞">–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞</option>
                            <option value="–í—Ç–æ—Ä–∏—á–∫–∞">–í—Ç–æ—Ä–∏—á–∫–∞</option>
                        </select>
                        <div id="e-category" class="error-text" style="display:none"></div>
                    </div>
                    <div class="full">
                        <label>–ê–¥—Ä–µ—Å</label>
                        <input id="f-address" />
                        <div id="e-address" class="error-text" style="display:none"></div>
                    </div>
                    <div>
                        <label>–ì–æ—Ä–æ–¥</label>
                        <input id="f-city" />
                        <div id="e-city" class="error-text" style="display:none"></div>
                    </div>
                    <div>
                        <label>–†–∞–π–æ–Ω</label>
                        <input id="f-district" />
                        <div id="e-district" class="error-text" style="display:none"></div>
                    </div>
                    <div>
                        <label>–ü–ª–æ—â–∞–¥—å (–º¬≤)</label>
                        <input id="f-area" type="number" step="0.1" />
                        <div id="e-area" class="error-text" style="display:none"></div>
                    </div>
                    <div>
                        <label>–ö–æ–º–Ω–∞—Ç</label>
                        <input id="f-rooms" type="number" />
                        <div id="e-rooms" class="error-text" style="display:none"></div>
                    </div>
                    <div id="f-floor-group">
                        <label>–≠—Ç–∞–∂</label>
                        <input id="f-floor" type="number" />
                        <div id="e-floor" class="error-text" style="display:none"></div>
                    </div>
                    <div>
                        <label>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</label>
                        <input id="f-floors" type="number" />
                        <div id="e-floors" class="error-text" style="display:none"></div>
                    </div>
                    <div>
                        <label>–¶–µ–Ω–∞</label>
                        <input id="f-price" type="number" step="0.01" />
                        <div id="e-price" class="error-text" style="display:none"></div>
                    </div>
                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
                    <div id="f-kitchen-area-group" style="display:none;">
                        <label>–ü–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏ (–º¬≤)</label>
                        <input id="f-kitchen-area" type="number" step="0.1" />
                    </div>
                    <div>
                        <label>–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</label>
                        <input id="f-year-built" type="number" min="1800" max="2100" />
                    </div>
                    <div id="f-building-material-group">
                        <label>–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–º–∞</label>
                        <select id="f-building-material">
                            <option value="">‚Äî</option>
                            <option value="–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π">–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π</option>
                            <option value="–ö–∏—Ä–ø–∏—á–Ω—ã–π">–ö–∏—Ä–ø–∏—á–Ω—ã–π</option>
                            <option value="–ü–∞–Ω–µ–ª—å–Ω—ã–π">–ü–∞–Ω–µ–ª—å–Ω—ã–π</option>
                            <option value="–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π">–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π</option>
                            <option value="–ë–ª–æ—á–Ω—ã–π">–ë–ª–æ—á–Ω—ã–π</option>
                        </select>
                    </div>
                    <div>
                        <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                        <select id="f-condition">
                            <option value="">‚Äî</option>
                            <option value="–ú–æ–∂–Ω–æ –∂–∏—Ç—å">–ú–æ–∂–Ω–æ –∂–∏—Ç—å</option>
                            <option value="–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞">–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞</option>
                            <option value="–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞">–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞</option>
                        </select>
                    </div>
                    <div id="f-plot-area-group" style="display:none;">
                        <label>–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞ (—Å–æ—Ç.)</label>
                        <input id="f-plot-area" type="number" step="0.1" />
                    </div>
                    <div id="f-land-category-group" style="display:none;">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å</label>
                        <input id="f-land-category" />
                    </div>
                    <div id="f-property-class-group" style="display:none;">
                        <label>–ö–ª–∞—Å—Å</label>
                        <select id="f-property-class">
                            <option value="">‚Äî</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                    <div>
                        <label>–ü–∞—Ä–∫–æ–≤–∫–∞</label>
                        <input id="f-parking" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 400 –º–µ—Å—Ç, –ù–∞–∑–µ–º–Ω–∞—è" />
                    </div>
                    <div id="f-bedrooms-group" style="display:none;">
                        <label>–°–ø–∞–ª–µ–Ω</label>
                        <input id="f-bedrooms" type="number" />
                    </div>
                    <div>
                        <label>–°–∞–Ω—É–∑–µ–ª</label>
                        <input id="f-bathrooms" type="number" />
                    </div>
                    <div id="f-window-view-group" style="display:none;">
                        <label>–í–∏–¥ –∏–∑ –æ–∫–æ–Ω</label>
                        <select id="f-window-view">
                            <option value="">‚Äî</option>
                            <option value="–ù–∞ —É–ª–∏—Ü—É">–ù–∞ —É–ª–∏—Ü—É</option>
                            <option value="–í–æ –¥–≤–æ—Ä">–í–æ –¥–≤–æ—Ä</option>
                            <option value="–ù–∞ –≥–æ—Ä–æ–¥">–ù–∞ –≥–æ—Ä–æ–¥</option>
                        </select>
                    </div>
                    <div>
                        <label>–ü—Ä–æ–¥–∞—ë—Ç—Å—è —Å –º–µ–±–µ–ª—å—é</label>
                        <select id="f-furnished">
                            <option value="">‚Äî</option>
                            <option value="true">–î–∞</option>
                            <option value="false">–ù–µ—Ç</option>
                        </select>
                    </div>
                    <div>
                        <label>–†–µ–º–æ–Ω—Ç</label>
                        <select id="f-renovation">
                            <option value="">‚Äî</option>
                            <option value="–î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π">–î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π</option>
                            <option value="–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π">–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π</option>
                            <option value="–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞">–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞</option>
                        </select>
                    </div>
                    <div>
                        <label>–û—Ç–æ–ø–ª–µ–Ω–∏–µ</label>
                        <select id="f-heating">
                            <option value="">‚Äî</option>
                            <option value="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ</option>
                            <option value="–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ">–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ</option>
                            <option value="–ì–∞–∑–æ–≤–æ–µ">–ì–∞–∑–æ–≤–æ–µ</option>
                        </select>
                    </div>
                    <div>
                        <label>–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ</label>
                        <select id="f-water-supply">
                            <option value="">‚Äî</option>
                            <option value="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ</option>
                            <option value="–°–∫–≤–∞–∂–∏–Ω–∞">–°–∫–≤–∞–∂–∏–Ω–∞</option>
                        </select>
                    </div>
                    <div>
                        <label>–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è</label>
                        <select id="f-sewerage">
                            <option value="">‚Äî</option>
                            <option value="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è</option>
                            <option value="–°–µ–ø—Ç–∏–∫">–°–µ–ø—Ç–∏–∫</option>
                        </select>
                    </div>
                    <div>
                        <label>–ì–∞–∑</label>
                        <select id="f-gas">
                            <option value="">‚Äî</option>
                            <option value="–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π">–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π</option>
                            <option value="–ë–∞–ª–ª–æ–Ω–Ω—ã–π">–ë–∞–ª–ª–æ–Ω–Ω—ã–π</option>
                            <option value="–ù–µ—Ç">–ù–µ—Ç</option>
                        </select>
                    </div>
                    <div>
                        <label>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ</label>
                        <select id="f-electricity">
                            <option value="">‚Äî</option>
                            <option value="–ï—Å—Ç—å">–ï—Å—Ç—å</option>
                            <option value="–ù–µ—Ç">–ù–µ—Ç</option>
                        </select>
                    </div>
                    <div class="full">
                        <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–¥–æ–±—Å—Ç–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                        <input id="f-amenities" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–µ—Ä—Ä–∞—Å–∞, –ì–∞—Ä–∞–∂, –ë–∞–Ω—è, –û—Ö—Ä–∞–Ω–∞" />
                    </div>
                    <div class="full">
                        <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</label>
                        <input id="f-files" type="file" accept="image/*" multiple />
                        <div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
                            <button type="button" class="btn-secondary-sm" onclick="uploadImages()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                            <span id="upload-status" style="font-size:12px; color:#64748b;"></span>
                        </div>
                    </div>
                    <div class="full">
                        <label>–§–æ—Ç–æ (URL —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏)</label>
                        <input id="f-images" placeholder="https://...jpg, https://...jpg" />
                    </div>
                    <div class="full">
                        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="f-description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-foot">
                    <button class="btn-secondary-sm" onclick="closePropertyModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button class="btn-primary-sm" onclick="saveProperty()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </main>

    <div id="toasts" class="toasts"></div>
    
    <div id="auth-modal" class="auth-modal">
        <div class="auth-modal-card">
            <h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è</h3>
            <p>–ß—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.</p>
            <div class="actions">
                <a th:href="@{/login}" class="btn-primary-sm">–í–æ–π—Ç–∏</a>
                <a th:href="@{/register}" class="btn-secondary-sm">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                <button class="btn-secondary-sm" onclick="closeAuthModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function showToast(message, type){
            const c = document.getElementById('toasts');
            if (!c) return;
            const d = document.createElement('div');
            d.className = `toast ${type||''}`;
            d.textContent = message;
            c.appendChild(d);
            setTimeout(()=>{ d.remove(); }, 3000);
        }
        function qs(id){return document.getElementById(id);}
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ - –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –∏–∑ Thymeleaf
        async function openPropertyView(propertyId) {
            console.log('openPropertyView –≤—ã–∑–≤–∞–Ω–∞ —Å propertyId:', propertyId);
            console.log('–¢–∏–ø openPropertyView:', typeof openPropertyView);
            console.log('window.openPropertyView:', typeof window.openPropertyView);
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –∏—Å—Ç–æ—Ä–∏—é (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            fetch(`/v1/api/view-history/${propertyId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).catch(err => console.error('Error recording view:', err));
            
            try {
                const res = await fetch('/v1/api/properties/' + propertyId);
                if (!res.ok) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', res.status, res.statusText);
                    const errorText = await res.text();
                    console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', errorText);
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
                    return;
                }
                let property;
                try {
                    property = await res.json();
                    console.log('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', property);
                } catch (parseError) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', parseError);
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏—è.', 'error');
                    return;
                }
                
                const modal = document.getElementById('property-view-modal');
                if (!modal) {
                    console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    showToast('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏
                const titleEl = modal.querySelector('.property-view-title');
                const priceEl = modal.querySelector('.property-view-price');
                const galleryEl = modal.querySelector('.property-view-gallery');
                const keyFeaturesEl = modal.querySelector('.property-view-key-features');
                const contentEl = modal.querySelector('.property-view-content-details');
                const descriptionEl = modal.querySelector('.property-view-description-text');
                const authorEl = modal.querySelector('.property-view-author-info');
                const chatBtnEl = modal.querySelector('.property-view-chat-btn');
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ü–µ–Ω—É
                const propertyType = property.type || '';
                const propertyTitle = propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' 
                    ? `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : propertyType === '–¥–æ–º'
                    ? `–î–æ–º ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è'
                    ? `–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : property.address || '–û–±—ä—è–≤–ª–µ–Ω–∏–µ';
                
                if (titleEl) titleEl.textContent = propertyTitle;
                if (priceEl) priceEl.textContent = property.price ? new Intl.NumberFormat('ru-RU').format(property.price) + ' ‚ÇΩ' : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                
                // –ì–∞–ª–µ—Ä–µ—è
                if (galleryEl) {
                    const imageUrls = property.imageUrls ? property.imageUrls.split(',').map(url => url.trim()).filter(url => url) : [];
                    if (imageUrls.length === 0) {
                        galleryEl.innerHTML = '<img src="https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop" alt="placeholder" />';
                        galleryEl.classList.add('single');
                    } else {
                        galleryEl.innerHTML = imageUrls.map(url => `<img src="${url}" alt="photo" onerror="this.src=\'https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop\'" />`).join('');
                        galleryEl.classList.toggle('single', imageUrls.length === 1);
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                if (keyFeaturesEl) {
                    const features = [];
                    if (property.area) features.push({icon: 'üìê', label: '–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å', value: property.area + ' –º¬≤'});
                    if (propertyType === '–¥–æ–º' && property.plotArea) features.push({icon: 'üèûÔ∏è', label: '–£—á–∞—Å—Ç–æ–∫', value: property.plotArea + ' —Å–æ—Ç.'});
                    if (propertyType === '–¥–æ–º' && property.buildingMaterial) features.push({icon: 'üèóÔ∏è', label: '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–º–∞', value: property.buildingMaterial});
                    if (propertyType === '–¥–æ–º' && property.floorsTotal) features.push({icon: 'ü™ú', label: '–≠—Ç–∞–∂–µ–π –≤ –¥–æ–º–µ', value: property.floorsTotal});
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.floor && property.floorsTotal) features.push({icon: 'ü™ú', label: '–≠—Ç–∞–∂', value: property.floor + ' –∏–∑ ' + property.floorsTotal});
                    if (propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' && property.floor && property.floorsTotal) features.push({icon: 'ü™ú', label: '–≠—Ç–∞–∂', value: property.floor + ' –∏–∑ ' + property.floorsTotal});
                    if (property.yearBuilt) features.push({icon: 'üìÖ', label: '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', value: property.yearBuilt});
                    if (propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' && property.propertyClass) features.push({icon: '‚≠ê', label: '–ö–ª–∞—Å—Å', value: property.propertyClass});
                    if (property.parking) features.push({icon: 'üÖøÔ∏è', label: '–ü–∞—Ä–∫–æ–≤–∫–∞', value: property.parking});
                    
                    if (features.length > 0) {
                        keyFeaturesEl.innerHTML = features.map(f => `
                            <div class="property-view-key-feature">
                                <div class="property-view-key-feature-icon">${f.icon}</div>
                                <div class="property-view-key-feature-text">
                                    <div class="property-view-key-feature-label">${f.label}</div>
                                    <div class="property-view-key-feature-value">${f.value}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        keyFeaturesEl.innerHTML = '';
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (contentEl) {
                    let html = '';
                    
                    // –°–µ–∫—Ü–∏—è "–û –∫–≤–∞—Ä—Ç–∏—Ä–µ" / "–û –¥–æ–º–µ" / "–û–± –æ–±—ä–µ–∫—Ç–µ"
                    const sectionTitle = propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' ? '–û –∫–≤–∞—Ä—Ç–∏—Ä–µ' 
                        : propertyType === '–¥–æ–º' ? '–û –¥–æ–º–µ' 
                        : '–û–± –æ–±—ä–µ–∫—Ç–µ';
                    
                    html += `<div class="property-view-section">
                        <div class="property-view-section-title">${sectionTitle}</div>
                        <div class="property-view-section-grid">`;
                    
                    if (property.area) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å</div><div class="property-view-value">${property.area} –º¬≤</div></div>`;
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.kitchenArea) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏</div><div class="property-view-value">${property.kitchenArea} –º¬≤</div></div>`;
                    if (property.rooms) html += `<div class="property-view-row"><div class="property-view-label">–ö–æ–º–Ω–∞—Ç</div><div class="property-view-value">${property.rooms}</div></div>`;
                    if (propertyType === '–¥–æ–º' && property.bedrooms) html += `<div class="property-view-row"><div class="property-view-label">–°–ø–∞–ª–µ–Ω</div><div class="property-view-value">${property.bedrooms}</div></div>`;
                    if (property.bathrooms) html += `<div class="property-view-row"><div class="property-view-label">–°–∞–Ω—É–∑–µ–ª</div><div class="property-view-value">${property.bathrooms} ${property.bathrooms === 1 ? '—Ä–∞–∑–¥–µ–ª—å–Ω—ã–π' : '—Ä–∞–∑–¥–µ–ª—å–Ω—ã—Ö'}</div></div>`;
                    if ((propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' || propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è') && property.floor !== null && property.floor !== undefined) {
                        if (property.floorsTotal) {
                            html += `<div class="property-view-row"><div class="property-view-label">–≠—Ç–∞–∂</div><div class="property-view-value">${property.floor} –∏–∑ ${property.floorsTotal}</div></div>`;
                        } else {
                            html += `<div class="property-view-row"><div class="property-view-label">–≠—Ç–∞–∂</div><div class="property-view-value">${property.floor}</div></div>`;
                        }
                    }
                    if (property.buildingMaterial) html += `<div class="property-view-row"><div class="property-view-label">–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–º–∞</div><div class="property-view-value">${property.buildingMaterial}</div></div>`;
                    if (property.condition) html += `<div class="property-view-row"><div class="property-view-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div><div class="property-view-value">${property.condition}</div></div>`;
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.windowView) html += `<div class="property-view-row"><div class="property-view-label">–í–∏–¥ –∏–∑ –æ–∫–æ–Ω</div><div class="property-view-value">${property.windowView}</div></div>`;
                    if (property.renovation) html += `<div class="property-view-row"><div class="property-view-label">–†–µ–º–æ–Ω—Ç</div><div class="property-view-value">${property.renovation}</div></div>`;
                    if (property.furnished !== null && property.furnished !== undefined) html += `<div class="property-view-row"><div class="property-view-label">–ü—Ä–æ–¥–∞—ë—Ç—Å—è —Å –º–µ–±–µ–ª—å—é</div><div class="property-view-value">${property.furnished ? '–î–∞' : '–ù–µ—Ç'}</div></div>`;
                    if (property.category) html += `<div class="property-view-row"><div class="property-view-label">–¢–∏–ø –∂–∏–ª—å—è</div><div class="property-view-value">${property.category}</div></div>`;
                    
                    html += `</div></div>`;
                    
                    // –°–µ–∫—Ü–∏—è "–û–± —É—á–∞—Å—Ç–∫–µ" (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–º–æ–≤)
                    if (propertyType === '–¥–æ–º' && (property.plotArea || property.landCategory)) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–û–± —É—á–∞—Å—Ç–∫–µ</div>
                            <div class="property-view-section-grid">`;
                        if (property.plotArea) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å</div><div class="property-view-value">${property.plotArea} —Å–æ—Ç.</div></div>`;
                        if (property.landCategory) html += `<div class="property-view-row"><div class="property-view-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å</div><div class="property-view-value">${property.landCategory}</div></div>`;
                        html += `</div></div>`;
                    }
                    
                    // –°–µ–∫—Ü–∏—è "–û –¥–æ–º–µ" (–¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏)
                    if ((propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' || propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è') && (property.yearBuilt || property.buildingMaterial || property.floorsTotal || property.parking)) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–û –¥–æ–º–µ</div>
                            <div class="property-view-section-grid">`;
                        if (property.yearBuilt) html += `<div class="property-view-row"><div class="property-view-label">–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</div><div class="property-view-value">${property.yearBuilt}</div></div>`;
                        if (property.buildingMaterial) html += `<div class="property-view-row"><div class="property-view-label">–¢–∏–ø –¥–æ–º–∞</div><div class="property-view-value">${property.buildingMaterial}</div></div>`;
                        if (property.floorsTotal) html += `<div class="property-view-row"><div class="property-view-label">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</div><div class="property-view-value">${property.floorsTotal}</div></div>`;
                        if (property.parking) html += `<div class="property-view-row"><div class="property-view-label">–ü–∞—Ä–∫–æ–≤–∫–∞</div><div class="property-view-value">${property.parking}</div></div>`;
                        html += `</div></div>`;
                    }
                    
                    // –°–µ–∫—Ü–∏—è "–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞"
                    if (property.heating || property.waterSupply || property.sewerage || property.gas || property.electricity || property.amenities) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞</div>
                            <div class="property-view-utilities">`;
                        if (property.heating) html += `<div class="property-view-utility"><span class="property-view-utility-label">–û—Ç–æ–ø–ª–µ–Ω–∏–µ</span><span class="property-view-utility-value">${property.heating}</span></div>`;
                        if (property.waterSupply) html += `<div class="property-view-utility"><span class="property-view-utility-label">–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ</span><span class="property-view-utility-value">${property.waterSupply}</span></div>`;
                        if (property.sewerage) html += `<div class="property-view-utility"><span class="property-view-utility-label">–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è</span><span class="property-view-utility-value">${property.sewerage}</span></div>`;
                        if (property.gas) html += `<div class="property-view-utility"><span class="property-view-utility-label">–ì–∞–∑</span><span class="property-view-utility-value">${property.gas}</span></div>`;
                        if (property.electricity) html += `<div class="property-view-utility"><span class="property-view-utility-label">–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ</span><span class="property-view-utility-value">${property.electricity}</span></div>`;
                        html += `</div>`;
                        if (property.amenities) {
                            const amenitiesList = property.amenities.split(',').map(a => a.trim()).filter(a => a);
                            if (amenitiesList.length > 0) {
                                html += `<div class="property-view-amenities">`;
                                amenitiesList.forEach(amenity => {
                                    html += `<span class="property-view-amenity">${amenity}</span>`;
                                });
                                html += `</div>`;
                            }
                        }
                        html += `</div>`;
                    }
                    
                    contentEl.innerHTML = html;
                }
                
                // –û–ø–∏—Å–∞–Ω–∏–µ
                if (descriptionEl) {
                    descriptionEl.innerHTML = property.description && property.description.trim() ? property.description : '‚Äî';
                }
                
                // –ê–≤—Ç–æ—Ä
                if (authorEl) {
                    const authorName = property.authorFirstName 
                        ? `${property.authorFirstName} ${property.authorLastName || ''}`.trim()
                        : property.authorEmail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    authorEl.innerHTML = `
                        <span>–ê–≤—Ç–æ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è:</span>
                        <span class="property-view-author-name">${authorName}</span>
                        ${property.isRealtor ? '<span class="property-view-author-badge">–†–∏–µ–ª—Ç–æ—Ä</span>' : ''}
                    `;
                }
                
                // –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –Ω–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
                if (chatBtnEl) {
                    const currentUserEmail = document.getElementById('current-user-email')?.textContent;
                    const isOwner = currentUserEmail && property.authorEmail && currentUserEmail === property.authorEmail;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º
                    if (currentUserEmail && !isOwner) {
                        chatBtnEl.style.display = 'inline-block';
                        chatBtnEl.onclick = (e) => {
                            e.stopPropagation();
                            openChatModal(propertyId, property);
                        };
                    } else {
                        chatBtnEl.style.display = 'none';
                    }
                }
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.classList.add('open');
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
                document.body.style.overflow = 'hidden';
                console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ');
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', err);
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
            }
        }
        
        function closePropertyView() {
            const modal = document.getElementById('property-view-modal');
            if (modal) {
                modal.classList.remove('open');
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
                document.body.style.overflow = '';
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('property-view-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePropertyView();
                    }
                });
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ
            if (typeof openPropertyView === 'undefined') {
                console.error('openPropertyView –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞!');
            } else {
                console.log('openPropertyView –¥–æ—Å—Ç—É–ø–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ');
                // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π —á–µ—Ä–µ–∑ window –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                window.openPropertyView = openPropertyView;
                window.closePropertyView = closePropertyView;
            }
        });
    </script>
    
    <script sec:authorize="isAuthenticated()">        
        async function openPropertyModal(btn){
            const m = qs('prop-modal');
            const title = qs('prop-modal-title');
            
            if (btn && btn.parentElement){
                // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
                const d = btn.parentElement;
                const propertyId = d.getAttribute('data-id');
                
                if (propertyId) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    title.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                    m.classList.add('open');
                    document.body.style.overflow = 'hidden';
                    
                    try {
                        const res = await fetch('/v1/api/properties/' + propertyId);
                        if (!res.ok) {
                            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                            m.classList.remove('open');
                            document.body.style.overflow = '';
                            return;
                        }
                        
                        const data = await res.json();
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ API
                        qs('f-id').value = data.id || '';
                        qs('f-type').value = data.type || '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
                        qs('f-category').value = data.category || '–í—Ç–æ—Ä–∏—á–∫–∞';
                        qs('f-address').value = data.address || '';
                        qs('f-city').value = data.city || '';
                        qs('f-district').value = data.district || '';
                        qs('f-area').value = data.area || '';
                        qs('f-rooms').value = data.rooms || '';
                        qs('f-floor').value = data.floor || '';
                        qs('f-floors').value = data.floorsTotal || '';
                        qs('f-price').value = data.price || '';
                        qs('f-images').value = data.imageUrls || '';
                        qs('f-description').value = data.description || '';
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                        if (qs('f-kitchen-area')) qs('f-kitchen-area').value = data.kitchenArea || '';
                        if (qs('f-year-built')) qs('f-year-built').value = data.yearBuilt || '';
                        if (qs('f-building-material')) qs('f-building-material').value = data.buildingMaterial || '';
                        if (qs('f-condition')) qs('f-condition').value = data.condition || '';
                        if (qs('f-plot-area')) qs('f-plot-area').value = data.plotArea || '';
                        if (qs('f-land-category')) qs('f-land-category').value = data.landCategory || '';
                        if (qs('f-property-class')) qs('f-property-class').value = data.propertyClass || '';
                        if (qs('f-parking')) qs('f-parking').value = data.parking || '';
                        if (qs('f-bedrooms')) qs('f-bedrooms').value = data.bedrooms || '';
                        if (qs('f-bathrooms')) qs('f-bathrooms').value = data.bathrooms || '';
                        if (qs('f-window-view')) qs('f-window-view').value = data.windowView || '';
                        if (qs('f-furnished')) qs('f-furnished').value = data.furnished !== null && data.furnished !== undefined ? (data.furnished ? 'true' : 'false') : '';
                        if (qs('f-renovation')) qs('f-renovation').value = data.renovation || '';
                        if (qs('f-heating')) qs('f-heating').value = data.heating || '';
                        if (qs('f-water-supply')) qs('f-water-supply').value = data.waterSupply || '';
                        if (qs('f-sewerage')) qs('f-sewerage').value = data.sewerage || '';
                        if (qs('f-gas')) qs('f-gas').value = data.gas || '';
                        if (qs('f-electricity')) qs('f-electricity').value = data.electricity || '';
                        if (qs('f-amenities')) qs('f-amenities').value = data.amenities || '';
                        
                        title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                        updateFormFieldsVisibility(data.type || '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', error);
                        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', 'error');
                        m.classList.remove('open');
                        document.body.style.overflow = '';
                        return;
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç ID, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (fallback)
                    qs('f-id').value = '';
                    qs('f-type').value = d.getAttribute('data-type') || '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
                    qs('f-category').value = d.getAttribute('data-category') || '–í—Ç–æ—Ä–∏—á–∫–∞';
                    qs('f-address').value = d.getAttribute('data-address') || '';
                    qs('f-city').value = d.getAttribute('data-city') || '';
                    qs('f-district').value = d.getAttribute('data-district') || '';
                    qs('f-area').value = d.getAttribute('data-area') || '';
                    qs('f-rooms').value = d.getAttribute('data-rooms') || '';
                    qs('f-floor').value = d.getAttribute('data-floor') || '';
                    qs('f-floors').value = d.getAttribute('data-floors') || '';
                    qs('f-price').value = d.getAttribute('data-price') || '';
                    qs('f-images').value = d.getAttribute('data-imageUrls') || '';
                    qs('f-description').value = d.getAttribute('data-description') || '';
                    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                    updateFormFieldsVisibility(d.getAttribute('data-type') || '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
                }
            } else {
                // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                ['f-id','f-address','f-city','f-district','f-area','f-rooms','f-floor','f-floors','f-price','f-images','f-description'].forEach(i=>qs(i).value='');
                // –û—á–∏—â–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                ['f-kitchen-area','f-year-built','f-building-material','f-condition','f-plot-area','f-land-category','f-property-class','f-parking','f-bedrooms','f-bathrooms','f-window-view','f-furnished','f-renovation','f-heating','f-water-supply','f-sewerage','f-gas','f-electricity','f-amenities'].forEach(i=>{
                    const el = qs(i);
                    if (el) el.value = '';
                });
                qs('f-type').value = '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
                qs('f-category').value = '–í—Ç–æ—Ä–∏—á–∫–∞';
                title.textContent = '–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                updateFormFieldsVisibility('–∫–≤–∞—Ä—Ç–∏—Ä–∞');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π
            const typeSelect = qs('f-type');
            if (typeSelect) {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                typeSelect.onchange = null;
                typeSelect.onchange = function() {
                    updateFormFieldsVisibility(this.value);
                };
            }
            
            m.classList.add('open');
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
            document.body.style.overflow = 'hidden';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –∏–∑ data-* –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (fallback)
        function fillFormFromDataAttributes(d, title) {
            qs('f-id').value = d.getAttribute('data-id') || '';
            qs('f-type').value = d.getAttribute('data-type') || '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
            qs('f-category').value = d.getAttribute('data-category') || '–í—Ç–æ—Ä–∏—á–∫–∞';
            qs('f-address').value = d.getAttribute('data-address') || '';
            qs('f-city').value = d.getAttribute('data-city') || '';
            qs('f-district').value = d.getAttribute('data-district') || '';
            qs('f-area').value = d.getAttribute('data-area') || '';
            qs('f-rooms').value = d.getAttribute('data-rooms') || '';
            qs('f-floor').value = d.getAttribute('data-floor') || '';
            qs('f-floors').value = d.getAttribute('data-floors') || '';
            qs('f-price').value = d.getAttribute('data-price') || '';
            qs('f-images').value = d.getAttribute('data-imageUrls') || '';
            qs('f-description').value = d.getAttribute('data-description') || '';
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            if (qs('f-kitchen-area')) qs('f-kitchen-area').value = d.getAttribute('data-kitchen-area') || '';
            if (qs('f-year-built')) qs('f-year-built').value = d.getAttribute('data-year-built') || '';
            if (qs('f-building-material')) qs('f-building-material').value = d.getAttribute('data-building-material') || '';
            if (qs('f-condition')) qs('f-condition').value = d.getAttribute('data-condition') || '';
            if (qs('f-plot-area')) qs('f-plot-area').value = d.getAttribute('data-plot-area') || '';
            if (qs('f-land-category')) qs('f-land-category').value = d.getAttribute('data-land-category') || '';
            if (qs('f-property-class')) qs('f-property-class').value = d.getAttribute('data-property-class') || '';
            if (qs('f-parking')) qs('f-parking').value = d.getAttribute('data-parking') || '';
            if (qs('f-bedrooms')) qs('f-bedrooms').value = d.getAttribute('data-bedrooms') || '';
            if (qs('f-bathrooms')) qs('f-bathrooms').value = d.getAttribute('data-bathrooms') || '';
            if (qs('f-window-view')) qs('f-window-view').value = d.getAttribute('data-window-view') || '';
            if (qs('f-furnished')) qs('f-furnished').value = d.getAttribute('data-furnished') || '';
            if (qs('f-renovation')) qs('f-renovation').value = d.getAttribute('data-renovation') || '';
            if (qs('f-heating')) qs('f-heating').value = d.getAttribute('data-heating') || '';
            if (qs('f-water-supply')) qs('f-water-supply').value = d.getAttribute('data-water-supply') || '';
            if (qs('f-sewerage')) qs('f-sewerage').value = d.getAttribute('data-sewerage') || '';
            if (qs('f-gas')) qs('f-gas').value = d.getAttribute('data-gas') || '';
            if (qs('f-electricity')) qs('f-electricity').value = d.getAttribute('data-electricity') || '';
            if (qs('f-amenities')) qs('f-amenities').value = d.getAttribute('data-amenities') || '';
            title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            updateFormFieldsVisibility(d.getAttribute('data-type') || '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        function updateFormFieldsVisibility(propertyType) {
            const kitchenAreaGroup = qs('f-kitchen-area-group');
            const plotAreaGroup = qs('f-plot-area-group');
            const landCategoryGroup = qs('f-land-category-group');
            const propertyClassGroup = qs('f-property-class-group');
            const bedroomsGroup = qs('f-bedrooms-group');
            const windowViewGroup = qs('f-window-view-group');
            const buildingMaterialGroup = qs('f-building-material-group');
            const floorGroup = qs('f-floor-group');
            
            if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞') {
                if (kitchenAreaGroup) kitchenAreaGroup.style.display = 'block';
                if (plotAreaGroup) plotAreaGroup.style.display = 'none';
                if (landCategoryGroup) landCategoryGroup.style.display = 'none';
                if (propertyClassGroup) propertyClassGroup.style.display = 'none';
                if (bedroomsGroup) bedroomsGroup.style.display = 'none';
                if (windowViewGroup) windowViewGroup.style.display = 'block';
                if (buildingMaterialGroup) buildingMaterialGroup.style.display = 'block';
                if (floorGroup) floorGroup.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ "–≠—Ç–∞–∂" –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä
            } else if (propertyType === '–¥–æ–º') {
                if (kitchenAreaGroup) kitchenAreaGroup.style.display = 'none';
                if (plotAreaGroup) plotAreaGroup.style.display = 'block';
                if (landCategoryGroup) landCategoryGroup.style.display = 'block';
                if (propertyClassGroup) propertyClassGroup.style.display = 'none';
                if (bedroomsGroup) bedroomsGroup.style.display = 'block';
                if (windowViewGroup) windowViewGroup.style.display = 'none';
                if (buildingMaterialGroup) buildingMaterialGroup.style.display = 'block';
                if (floorGroup) floorGroup.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ "–≠—Ç–∞–∂" –¥–ª—è –¥–æ–º–æ–≤
            } else if (propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è') {
                if (kitchenAreaGroup) kitchenAreaGroup.style.display = 'none';
                if (plotAreaGroup) plotAreaGroup.style.display = 'none';
                if (landCategoryGroup) landCategoryGroup.style.display = 'none';
                if (propertyClassGroup) propertyClassGroup.style.display = 'block';
                if (bedroomsGroup) bedroomsGroup.style.display = 'none';
                if (windowViewGroup) windowViewGroup.style.display = 'none';
                if (buildingMaterialGroup) buildingMaterialGroup.style.display = 'block';
                if (floorGroup) floorGroup.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ "–≠—Ç–∞–∂" –¥–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
            }
        }
        function closePropertyModal(){ 
            const m = qs('prop-modal');
            if (m) {
                m.classList.remove('open');
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
                document.body.style.overflow = '';
            }
        }
        function clearErrors(){
            ['type','category','address','city','district','area','rooms','floor','floors','price']
                .forEach(k=>{ const el = qs('e-'+k); if (el) { el.style.display='none'; el.textContent=''; }});
        }
        function validate(){
            clearErrors();
            let ok = true;
            function err(id,msg){ const el = qs('e-'+id); if(el){ el.textContent = msg; el.style.display='block'; } ok=false; }
            if (!qs('f-address').value.trim()) err('address','–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å');
            if (!qs('f-city').value.trim()) err('city','–£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥');
            const area = parseFloat(qs('f-area').value||0); if (!(area>0)) err('area','–ü–ª–æ—â–∞–¥—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0');
            const price = parseFloat(qs('f-price').value||0); if (!(price>0)) err('price','–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0');
            return ok;
        }
        async function saveProperty(){
            if (!validate()) { showToast('–ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ', 'error'); return; }
            try {
                const id = qs('f-id').value;
                // –û—á–∏—â–∞–µ–º imageUrls –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                let imageUrlsValue = qs('f-images').value || '';
                if (imageUrlsValue) {
                    // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π, —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ
                    const urls = imageUrlsValue.split(',')
                        .map(url => url.trim())
                        .filter(url => url.length > 0);
                    imageUrlsValue = urls.join(',');
                }
                
                const payload = {
                    type: qs('f-type').value,
                    category: qs('f-category').value,
                    address: qs('f-address').value,
                    city: qs('f-city').value,
                    district: qs('f-district').value || '',
                    area: parseFloat(qs('f-area').value||0),
                    rooms: qs('f-rooms').value ? parseInt(qs('f-rooms').value) : null,
                    floor: (qs('f-floor-group') && qs('f-floor-group').style.display !== 'none' && qs('f-floor').value) ? parseInt(qs('f-floor').value) : null,
                    floorsTotal: qs('f-floors').value ? parseInt(qs('f-floors').value) : null,
                    price: parseFloat(qs('f-price').value||0),
                    imageUrls: imageUrlsValue,
                    description: qs('f-description').value || '',
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                    kitchenArea: qs('f-kitchen-area') && qs('f-kitchen-area').value ? parseFloat(qs('f-kitchen-area').value) : null,
                    yearBuilt: qs('f-year-built') && qs('f-year-built').value ? parseInt(qs('f-year-built').value) : null,
                    buildingMaterial: qs('f-building-material') && qs('f-building-material').value ? qs('f-building-material').value : null,
                    condition: qs('f-condition') && qs('f-condition').value ? qs('f-condition').value : null,
                    plotArea: qs('f-plot-area') && qs('f-plot-area').value ? parseFloat(qs('f-plot-area').value) : null,
                    landCategory: qs('f-land-category') && qs('f-land-category').value ? qs('f-land-category').value : null,
                    propertyClass: qs('f-property-class') && qs('f-property-class').value ? qs('f-property-class').value : null,
                    parking: qs('f-parking') && qs('f-parking').value ? qs('f-parking').value : null,
                    bedrooms: qs('f-bedrooms') && qs('f-bedrooms').value ? parseInt(qs('f-bedrooms').value) : null,
                    bathrooms: qs('f-bathrooms') && qs('f-bathrooms').value ? parseInt(qs('f-bathrooms').value) : null,
                    windowView: qs('f-window-view') && qs('f-window-view').value ? qs('f-window-view').value : null,
                    furnished: qs('f-furnished') && qs('f-furnished').value ? qs('f-furnished').value === 'true' : null,
                    renovation: qs('f-renovation') && qs('f-renovation').value ? qs('f-renovation').value : null,
                    heating: qs('f-heating') && qs('f-heating').value ? qs('f-heating').value : null,
                    waterSupply: qs('f-water-supply') && qs('f-water-supply').value ? qs('f-water-supply').value : null,
                    sewerage: qs('f-sewerage') && qs('f-sewerage').value ? qs('f-sewerage').value : null,
                    gas: qs('f-gas') && qs('f-gas').value ? qs('f-gas').value : null,
                    electricity: qs('f-electricity') && qs('f-electricity').value ? qs('f-electricity').value : null,
                    amenities: qs('f-amenities') && qs('f-amenities').value ? qs('f-amenities').value : null
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', payload);
                
                const url = id ? `/v1/api/properties/${id}` : '/v1/api/properties';
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, { 
                    method, 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', res.status, res.statusText);
                
                if (!res.ok) {
                    let errorText = '';
                    try {
                        errorText = await res.text();
                    } catch (e) {
                        errorText = '–û—à–∏–±–∫–∞ ' + res.status;
                    }
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', errorText);
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + (errorText || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'), 'error');
                    return;
                }
                
                // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è
                let data = null;
                try {
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const responseText = await res.text();
                        if (responseText && responseText.trim().length > 0) {
                            data = JSON.parse(responseText);
                            console.log('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:', data);
                        }
                    }
                } catch (parseError) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ):', parseError);
                }
                
                showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
                closePropertyModal();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    try {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.location.href –≤–º–µ—Å—Ç–æ reload –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                        window.location.href = '/';
                    } catch (reloadError) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:', reloadError);
                        window.location.href = '/';
                    }
                }, 500);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', e);
                console.error('–°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', e.stack);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        }
        async function deleteProperty(btn){
            const id = btn.parentElement.getAttribute('data-id');
            if (!id) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
            const res = await fetch(`/v1/api/properties/${id}`, { method: 'DELETE' });
            if (!res.ok) { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error'); return; }
            showToast('–£–¥–∞–ª–µ–Ω–æ', 'success');
            location.reload();
        }
        async function togglePromote(propertyId, buttonElement){
            try {
                const isPromoted = buttonElement.textContent.trim() === '–°–Ω—è—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ';
                const endpoint = isPromoted ? `/v1/api/properties/${propertyId}/unpromote` : `/v1/api/properties/${propertyId}/promote`;
                const res = await fetch(endpoint, { method: 'POST' });
                if (!res.ok) { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ', 'error'); return; }
                showToast(isPromoted ? '–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å–Ω—è—Ç–æ' : '–û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ', 'success');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                buttonElement.textContent = isPromoted ? '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å' : '–°–Ω—è—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ';
                buttonElement.classList.toggle('promoted-btn');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                setTimeout(() => location.reload(), 500);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è:', e);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è', 'error');
            }
        }
        async function uploadImages(){
            const filesInput = qs('f-files');
            const statusEl = document.getElementById('upload-status');
            if (!filesInput || !filesInput.files || filesInput.files.length === 0) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã', 'error'); return; }
            const fd = new FormData();
            Array.from(filesInput.files).forEach(f => fd.append('files', f));
            statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            try {
                const res = await fetch('/v1/api/uploads/images', { method: 'POST', body: fd });
                if (!res.ok) { showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error'); statusEl.textContent=''; return; }
                const urls = await res.json();
                const current = qs('f-images').value.trim();
                const appended = urls.join(',');
                qs('f-images').value = current ? (current + ',' + appended) : appended;
                statusEl.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ' + urls.length;
                showToast('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ', 'error');
                statusEl.textContent='';
            }
        }
    </script>
    
    <script>
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä edit
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            if (editId) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ API
                fetch('/v1/api/properties/' + editId)
                    .then(res => {
                        if (!res.ok) {
                            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                            return null;
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (!data) return;
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                        qs('f-id').value = data.id || '';
                        qs('f-type').value = data.type || '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
                        qs('f-category').value = data.category || '–í—Ç–æ—Ä–∏—á–∫–∞';
                        qs('f-address').value = data.address || '';
                        qs('f-city').value = data.city || '';
                        qs('f-district').value = data.district || '';
                        qs('f-area').value = data.area || '';
                        qs('f-rooms').value = data.rooms || '';
                        qs('f-floor').value = data.floor || '';
                        qs('f-floors').value = data.floorsTotal || '';
                        qs('f-price').value = data.price || '';
                        qs('f-images').value = data.imageUrls || '';
                        qs('f-description').value = data.description || '';
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                        if (qs('f-kitchen-area')) qs('f-kitchen-area').value = data.kitchenArea || '';
                        if (qs('f-year-built')) qs('f-year-built').value = data.yearBuilt || '';
                        if (qs('f-building-material')) qs('f-building-material').value = data.buildingMaterial || '';
                        if (qs('f-condition')) qs('f-condition').value = data.condition || '';
                        if (qs('f-plot-area')) qs('f-plot-area').value = data.plotArea || '';
                        if (qs('f-land-category')) qs('f-land-category').value = data.landCategory || '';
                        if (qs('f-property-class')) qs('f-property-class').value = data.propertyClass || '';
                        if (qs('f-parking')) qs('f-parking').value = data.parking || '';
                        if (qs('f-bedrooms')) qs('f-bedrooms').value = data.bedrooms || '';
                        if (qs('f-bathrooms')) qs('f-bathrooms').value = data.bathrooms || '';
                        if (qs('f-window-view')) qs('f-window-view').value = data.windowView || '';
                        if (qs('f-furnished')) qs('f-furnished').value = data.furnished !== null && data.furnished !== undefined ? (data.furnished ? 'true' : 'false') : '';
                        if (qs('f-renovation')) qs('f-renovation').value = data.renovation || '';
                        if (qs('f-heating')) qs('f-heating').value = data.heating || '';
                        if (qs('f-water-supply')) qs('f-water-supply').value = data.waterSupply || '';
                        if (qs('f-sewerage')) qs('f-sewerage').value = data.sewerage || '';
                        if (qs('f-gas')) qs('f-gas').value = data.gas || '';
                        if (qs('f-electricity')) qs('f-electricity').value = data.electricity || '';
                        if (qs('f-amenities')) qs('f-amenities').value = data.amenities || '';
                        
                        qs('prop-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                        updateFormFieldsVisibility(data.type || '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
                        
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        const modal = qs('prop-modal');
                        if (modal) {
                            modal.classList.add('open');
                        }
                        
                        // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä edit –∏–∑ URL
                        const newUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                    })
                    .catch(err => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                    });
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function loadFavoriteStates() {
            try {
                const res = await fetch('/v1/api/favorites/my-ids');
                if (res.ok) {
                    const data = await res.json();
                    const favoriteIds = data.favoriteIds || [];
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å "added" –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö ID –≤ —Å–ø–∏—Å–∫–µ
                    document.querySelectorAll('.favorite-btn').forEach(btn => {
                        const propertyId = parseInt(btn.getAttribute('data-property-id'));
                        if (favoriteIds.includes(propertyId)) {
                            btn.classList.add('added');
                        }
                    });
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ:', e);
            }
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadFavoriteStates);
        
        async function toggleFavorite(propertyId, buttonElement){
            try {
                const res = await fetch(`/v1/api/favorites/toggle/${propertyId}`, { method: 'POST' });
                
                if (res.status === 401) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    showAuthModal();
                    return;
                }
                
                const data = await res.json();
                
                if (data.requiresAuth) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    showAuthModal();
                    return;
                }
                
                if (data.success && buttonElement) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                    if (data.favorited) {
                        buttonElement.classList.add('added');
                    } else {
                        buttonElement.classList.remove('added');
                    }
                } else if (!data.success) {
                    console.error('–û—à–∏–±–∫–∞:', data.message);
                }
            } catch (e) {
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ:', e);
                showAuthModal();
            }
        }
        
        function showAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                modal.classList.add('open');
            }
        }
        
        function closeAuthModal() {
            const modal = document.getElementById('auth-modal');
            if (modal) {
                modal.classList.remove('open');
            }
        }
        
    </script>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
    <div id="property-view-modal" class="property-view-modal">
        <div class="property-view-card">
            <button class="property-view-close" onclick="closePropertyView()">√ó</button>
            <div class="property-view-gallery">
                <!-- –ì–∞–ª–µ—Ä–µ—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <div class="property-view-content">
                <div class="property-view-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="property-view-price">‚Äî</div>
                <div class="property-view-key-features">
                    <!-- –ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="property-view-content-details">
                    <!-- –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="property-view-description">
                    <div class="property-view-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    <div class="property-view-value property-view-description-text">‚Äî</div>
                </div>
                <div class="property-view-author property-view-author-info">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <button class="property-view-chat-btn" style="display:none;">–°–≤—è–∑–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>
    
    <div id="chat-modal" class="chat-modal" sec:authorize="isAuthenticated()">
        <div class="chat-modal-card">
            <div class="chat-modal-header">
                <div class="chat-modal-header-left">
                    <h3>–ß–∞—Ç –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é: <span class="property-link" id="chat-modal-property-link"></span></h3>
                    <div class="chat-user-info" id="chat-modal-user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <button class="chat-modal-close" onclick="closeChatModal()">√ó</button>
            </div>
            <div class="chat-modal-messages" id="chat-modal-messages">
                <div class="chat-modal-empty">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            <div class="chat-modal-input-area">
                <input type="text" id="chat-modal-message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendChatModalMessage()" />
                <button onclick="sendChatModalMessage()" id="chat-modal-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script sec:authorize="isAuthenticated()">
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–∞–ª—å–Ω—ã–º –æ–∫–Ω–æ–º —á–∞—Ç–∞ (–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å)
        let currentChatId = null;
        let currentPropertyId = null;
        let chatPollingInterval = null;
        
        async function openChatModal(propertyId, property) {
            try {
                currentPropertyId = propertyId;
                const modal = document.getElementById('chat-modal');
                if (!modal) {
                    window.location.href = '/chat?propertyId=' + propertyId;
                    return;
                }
                
                const propertyLink = document.getElementById('chat-modal-property-link');
                if (propertyLink && property) {
                    let propertyInfo = property.address || '';
                    if (property.city) propertyInfo += ', ' + property.city;
                    if (property.type !== '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' && property.rooms) {
                        propertyInfo += ' ¬∑ ' + property.rooms + ' –∫–æ–º–Ω';
                    }
                    if (property.price) {
                        propertyInfo += ' ¬∑ ' + new Intl.NumberFormat('ru-RU').format(property.price) + ' ‚ÇΩ';
                    }
                    propertyLink.textContent = propertyInfo;
                    propertyLink.onclick = () => {
                        closeChatModal();
                        openPropertyView(propertyId);
                    };
                }
                
                if (property && property.authorEmail) {
                    const userInfoEl = document.getElementById('chat-modal-user-info');
                    if (userInfoEl) {
                        const authorName = property.authorName || property.authorEmail;
                        userInfoEl.textContent = `–° ${authorName}${property.isRealtor ? ' (–†–∏–µ–ª—Ç–æ—Ä)' : ''}`;
                    }
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —á–∞—Ç —á–µ—Ä–µ–∑ API
                try {
                    const createChatResponse = await fetch(`/v1/api/chat/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ propertyId: propertyId })
                    });
                    
                    if (createChatResponse.ok) {
                        const createData = await createChatResponse.json();
                        if (createData.chatId) {
                            currentChatId = createData.chatId;
                            await loadChatMessages(currentChatId);
                            startChatPolling();
                        } else {
                            console.error('Chat ID –Ω–µ –ø–æ–ª—É—á–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ:', createData);
                            const messagesEl = document.getElementById('chat-modal-messages');
                            if (messagesEl) {
                                messagesEl.innerHTML = '<div class="chat-modal-empty">–û—à–∏–±–∫–∞: ID —á–∞—Ç–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>';
                            }
                        }
                    } else if (createChatResponse.status === 403) {
                        const messagesEl = document.getElementById('chat-modal-messages');
                        if (messagesEl) {
                            messagesEl.innerHTML = '<div class="chat-modal-empty">–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ</div>';
                        }
                        const inputArea = document.querySelector('.chat-modal-input-area');
                        if (inputArea) {
                            inputArea.style.display = 'none';
                        }
                    } else {
                        // –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ ‚Äî –ø–æ–∑–≤–æ–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                        try {
                            const errorData = await createChatResponse.json();
                            const errorMsg = errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞';
                            console.warn('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Ç–∞:', errorMsg);
                            const messagesEl = document.getElementById('chat-modal-messages');
                            if (messagesEl) {
                                messagesEl.innerHTML = `<div class=\"chat-modal-empty\">${errorMsg}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>`;
                            }
                        } catch (parseError) {
                            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞:', parseError);
                            const messagesEl = document.getElementById('chat-modal-messages');
                            if (messagesEl) {
                                messagesEl.innerHTML = '<div class="chat-modal-empty">–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>';
                            }
                        }
                    }
                } catch (createError) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–ø–æ–ª—É—á–µ–Ω–∏–∏ —á–∞—Ç–∞:', createError);
                    const messagesEl = document.getElementById('chat-modal-messages');
                    if (messagesEl) {
                        messagesEl.innerHTML = '<div class="chat-modal-empty">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —á–∞—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>';
                    }
                }
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Å–µ–≥–¥–∞
                modal.classList.add('open');
                document.body.style.overflow = 'hidden';
                setTimeout(() => { document.getElementById('chat-modal-message-input')?.focus(); }, 100);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞:', error);
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç', 'error');
            }
        }
        
        function closeChatModal() {
            const modal = document.getElementById('chat-modal');
            if (modal) {
                modal.classList.remove('open');
                document.body.style.overflow = '';
            }
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
                chatPollingInterval = null;
            }
            currentChatId = null;
            currentPropertyId = null;
        }
        
        async function loadChatMessages(chatId) {
            try {
                if (!chatId) {
                    const messagesEl = document.getElementById('chat-modal-messages');
                    if (messagesEl) {
                        messagesEl.innerHTML = '<div class="chat-modal-empty">–ß–∞—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>';
                    }
                    return;
                }
                const response = await fetch(`/v1/api/chat/${chatId}/messages`);
                if (!response.ok) {
                    if (response.status === 403 || response.status === 404) {
                        const messagesEl = document.getElementById('chat-modal-messages');
                        if (messagesEl) {
                            messagesEl.innerHTML = '<div class="chat-modal-empty">–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞</div>';
                        }
                        return;
                    }
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
                }
                const messages = await response.json();
                const messagesEl = document.getElementById('chat-modal-messages');
                if (!messagesEl) return;
                if (!messages || messages.length === 0) {
                    messagesEl.innerHTML = '<div class="chat-modal-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É, –æ—Ç–ø—Ä–∞–≤–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>';
                    return;
                }
                const currentUserEmail = document.getElementById('current-user-email')?.textContent;
                messagesEl.innerHTML = messages.map(msg => {
                    const isOwn = msg.userEmail === currentUserEmail;
                    const userInitial = (msg.userFirstName || msg.userEmail || 'U').charAt(0).toUpperCase();
                    const sentDate = new Date(msg.sentDate);
                    const timeStr = sentDate.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="chat-modal-message ${isOwn ? 'own' : ''}">
                            <div class="chat-modal-message-avatar">${userInitial}</div>
                            <div class="chat-modal-message-content">
                                <div class="chat-modal-message-bubble">
                                    <div class="chat-modal-message-text">${escapeHtml(msg.messageText)}</div>
                                </div>
                                <div class="chat-modal-message-time">${timeStr}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                const messagesEl = document.getElementById('chat-modal-messages');
                if (messagesEl) {
                    messagesEl.innerHTML = '<div class="chat-modal-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                }
            }
        }
        
        async function sendChatModalMessage() {
            if (!currentChatId && currentPropertyId) {
                try {
                    const createChatResponse = await fetch(`/v1/api/chat/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ propertyId: currentPropertyId })
                    });
                    if (createChatResponse.ok) {
                        const createData = await createChatResponse.json();
                        if (createData.chatId) {
                            currentChatId = createData.chatId;
                            startChatPolling();
                        } else {
                            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç', 'error');
                            return;
                        }
                    } else {
                        showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —á–∞—Ç', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞:', error);
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞', 'error');
                    return;
                }
            }
            if (!currentChatId) {
                showToast('–ß–∞—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }
            const input = document.getElementById('chat-modal-message-input');
            const sendBtn = document.getElementById('chat-modal-send-btn');
            const messageText = input?.value.trim();
            if (!messageText) return;
            sendBtn.disabled = true;
            try {
                const response = await fetch(`/v1/api/chat/${currentChatId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageText: messageText })
                });
                if (!response.ok) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ');
                }
                input.value = '';
                await loadChatMessages(currentChatId);
                if (window.checkUnreadMessages) {
                    window.checkUnreadMessages();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', 'error');
            } finally {
                sendBtn.disabled = false;
                input?.focus();
            }
        }
        
        function startChatPolling() {
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
            }
            if (!currentChatId) {
                return;
            }
            chatPollingInterval = setInterval(async () => {
                if (currentChatId) {
                    await loadChatMessages(currentChatId);
                } else {
                    if (chatPollingInterval) {
                        clearInterval(chatPollingInterval);
                        chatPollingInterval = null;
                    }
                }
            }, 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω –∏ –ø–æ Escape
        document.addEventListener('click', function(e) {
            const chatModal = document.getElementById('chat-modal');
            if (chatModal && e.target === chatModal) {
                closeChatModal();
            }
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const chatModal = document.getElementById('chat-modal');
                if (chatModal && chatModal.classList.contains('open')) {
                    closeChatModal();
                }
            }
        });
    </script>

    <script sec:authorize="isAuthenticated()">
        // –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
        let lastUnreadCount = 0;
        let pollingInterval = null;
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
        window.checkUnreadMessages = async function checkUnreadMessages() {
            try {
                const res = await fetch('/v1/api/chat/unread-count');
                if (!res.ok) {
                    return;
                }
                const data = await res.json();
                const unreadCount = data.unreadCount || 0;
                
                const badge = document.getElementById('chats-badge');
                if (badge) {
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (unreadCount > lastUnreadCount && lastUnreadCount > 0) {
                    const newMessages = unreadCount - lastUnreadCount;
                    showToast(`–£ –≤–∞—Å ${newMessages} –Ω–æ–≤${newMessages === 1 ? '–æ–µ' : newMessages < 5 ? '—ã—Ö' : '—ã—Ö'} —Å–æ–æ–±—â–µ–Ω–∏${newMessages === 1 ? '–µ' : newMessages < 5 ? '—è' : '–π'}`, 'success');
                }
                
                lastUnreadCount = unreadCount;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º polling –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        document.addEventListener('DOMContentLoaded', function() {
            const currentUserEmail = document.getElementById('current-user-email');
            if (currentUserEmail && currentUserEmail.textContent) {
                // –ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–∞–∑—É
                checkUnreadMessages();
                
                // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
                pollingInterval = setInterval(window.checkUnreadMessages, 5000);
            }
        });
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º polling –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });
    </script>
</body>
<script src="/js/hotkeys.js"></script>
</html>