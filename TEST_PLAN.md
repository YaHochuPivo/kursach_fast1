# Тест-план проекта RealEstate

## 1. Окружение
- Профиль test: H2, Flyway выключен.
- Профиль dev/prod: PostgreSQL, Flyway включен.
- Переменные окружения: MAIL_*, DB_*.

## 2. Области тестирования
- Роли и доступ: USER/REALTOR/ADMIN.
- Архивация объявлений.
- CSV экспорт/импорт объявлений.
- Отчеты (/reports): данные, фильтры, CSV.
- Настройки пользователя (UserSettings): загрузка/сохранение.
- Горячие клавиши.
- Миграции БД (Flyway) и аудиты.

## 3. Тест-кейсы

### 3.1 Архивация объявлений
- TC-A1: ADMIN архивирует объявление
  - Предусловия: объявление со статусом active, создано пользователем.
  - Шаги: POST /v1/api/properties/{id}/archive под ADMIN.
  - Ожидание: 200 OK, статус = archived, запись аудита.
- TC-A2: ADMIN разархивирует
  - Шаги: POST /v1/api/properties/{id}/unarchive под ADMIN.
  - Ожидание: 200 OK, статус = active, запись аудита.
- TC-A3: Владелец архивирует своё
  - Под USER-владельцем, ожидание 200 OK.
- TC-A4: Чужой пользователь пытается архивировать
  - Под другим USER, ожидание 403.
- TC-A5: Неавторизованный
  - Ожидание 401.

### 3.2 CSV экспорт/импорт объявлений
- TC-C1: Экспорт CSV текущего пользователя
  - GET /v1/api/properties/csv/export под USER, ожидание 200, content-type text/csv, строки с его объявлениями.
- TC-C2: Импорт валидного CSV
  - POST /v1/api/properties/csv/import (multipart file) под USER.
  - Ожидание: 200, увеличилось кол-во объявлений.
- TC-C3: Импорт с ошибочными строками
  - В CSV пропустить обязательные поля.
  - Ожидание: 400/422 и список ошибок (если реализована детальная валидация).
- TC-C4: Импорт для неавторизованного
  - Ожидание 401.

### 3.3 Отчеты
- TC-R1: Доступ к /reports для авторизованного
  - Ожидание: 200, отображение графиков и таблиц.
- TC-R2: Фильтры по датам применяются
  - Ожидание: обновление данных таблицы/графиков.
- TC-R3: CSV экспорт с отчета
  - Ожидание: скачивание CSV, корректный заголовок и строки.

### 3.4 Настройки пользователя (UserSettings)
- TC-S1: GET /v1/api/user-settings под USER без настроек
  - Ожидание: 200, пустые поля по умолчанию.
- TC-S2: POST /v1/api/user-settings сохранение
  - Ожидание: 200, повторный GET возвращает сохранённые значения.
- TC-S3: Неавторизованный доступ
  - Ожидание 401.
- TC-S4: Поля pageSize нечисловые
  - Ожидание: сохранение игнорирует некорректное, ошибки не приводят к падению.

### 3.5 Горячие клавиши
- TC-H1: g h ведёт на /
- TC-H2: g p ведёт на /properties
- TC-H3: g m ведёт на /user/properties
- TC-H4: g r ведёт на /reports
- TC-H5: / фокус на поиске (главная)
- TC-H6: n открывает «новое объявление» (если доступно)
- TC-H7: s — фокус на настройках профиля (в профиле)
- TC-H8: ? — всплывающее окно со справкой

### 3.6 Миграции и аудит
- TC-M1: На чистой БД Flyway применяет V1..V3 без ошибок
- TC-M2: В таблицах существуют:
  - audit_log_db + триггеры fn_audit_generic
  - view v_property_summary, v_deal_summary (если есть deals)
- TC-M3: Операции INSERT/UPDATE/DELETE по properties создают записи в audit_log_db

## 4. Набор интеграционных тестов (автоматизация)
- PropertyApiArchiveTests
- PropertyCsvTests
- (опционально) ReportsApiTests, UserSettingsApiTests — по мере необходимости.

## 5. Нефункциональные
- Безопасность: запреты 401/403, проверка ролей.
- Производительность: экспорт CSV < 2с на 1000 записей (локально).
- UX: хоткеи не мешают вводу в полях.

## 6. Запуск тестов
```
mvn -Dspring.profiles.active=test test
```

## 7. Критерии приёмки
- Архивация/разархивирование и CSV импорт/экспорт работают с корректными статусами и правами.
- Отчеты доступны и экспортируют данные.
- Настройки пользователя сохраняются и подгружаются.
- Хоткеи работают на заявленных страницах.
- Миграции применяются на пустой БД без ошибок, аудит пишет записи.
