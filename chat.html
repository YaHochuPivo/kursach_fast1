<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ß–∞—Ç –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é</title>
    <style>
        body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#ffffff; color:#0f172a; }
        .container { max-width: 1000px; margin: 0 auto; padding: 16px; }
        .nav { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid #dbeafe; margin-bottom:16px; }
        .brand { display:flex; align-items:center; gap:10px; font-weight:700; color:#1e293b; }
        .brand .logo { width:30px; height:30px; display:grid; place-items:center; border-radius:6px; background:#2563eb; color:#fff; font-size:16px; }
        .back { color:#2563eb; text-decoration:none; }
        .chat-header { background:#eff6ff; padding:12px; border-radius:8px; margin-bottom:16px; }
        .chat-header h2 { margin:0 0 8px; font-size:18px; color:#0f172a; line-height:1.5; }
        .chat-header h2 .property-link { color:#2563eb; text-decoration:none; font-weight:700; transition:color 0.2s; border-bottom:1px dotted #2563eb; }
        .chat-header h2 .property-link:hover { color:#1e40af; border-bottom-color:#1e40af; text-decoration:none; }
        .chat-header p { margin:0; color:#64748b; font-size:14px; }
        .messages { height:500px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; padding:16px; margin-bottom:16px; background:#f8fafc; }
        .message { margin-bottom:16px; display:flex; gap:12px; }
        .message.own { flex-direction:row-reverse; }
        .message-avatar { width:40px; height:40px; border-radius:50%; background:#2563eb; color:#fff; display:grid; place-items:center; font-weight:600; flex-shrink:0; }
        .message-content { flex:1; max-width:70%; }
        .message-bubble { padding:10px 14px; border-radius:12px; background:#fff; border:1px solid #e2e8f0; }
        .message.own .message-bubble { background:#2563eb; color:#fff; border-color:#2563eb; }
        .message-author { font-size:12px; color:#64748b; margin-bottom:4px; }
        .message.own .message-author { text-align:right; }
        .message-text { margin:0; word-wrap:break-word; }
        .message-time { font-size:11px; color:#94a3b8; margin-top:4px; }
        .message.own .message-time { text-align:right; }
        .message-read { font-size:10px; color:#64748b; margin-top:2px; font-style:italic; }
        .message.own .message-read { text-align:right; }
        .input-area { display:flex; gap:8px; }
        .input-area input { flex:1; padding:12px; border:1px solid #e2e8f0; border-radius:8px; }
        .input-area button { padding:12px 24px; border:none; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer; font-weight:600; }
        .input-area button:hover { background:#1e40af; }
        .input-area button:disabled { background:#94a3b8; cursor:not-allowed; }
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ */
        .property-view-modal { position: fixed; inset:0; background: rgba(15,23,42,.7); display:none; align-items:center; justify-content:center; z-index:10000; overflow-y:auto; padding:20px; }
        .property-view-modal.open { display:flex; }
        .property-view-card { width: 900px; max-width: calc(100% - 40px); background:#fff; border-radius:8px; border:1px solid #e2e8f0; overflow:hidden; position:relative; margin:auto; }
        .property-view-gallery { width:100%; background:#eff6ff; display:flex; gap:8px; overflow:auto; padding:8px; border-bottom:1px solid #dbeafe; }
        .property-view-gallery img { height:320px; border-radius:6px; object-fit:cover; flex-shrink:0; }
        .property-view-gallery.single { justify-content:center; }
        .property-view-gallery.single img { width:100%; height:auto; max-height:520px; }
        .property-view-content { padding:20px; }
        .property-view-title { font-size:24px; font-weight:700; margin:0 0 12px; color:#0f172a; }
        .property-view-price { font-size:20px; font-weight:700; color:#0f172a; margin:0 0 20px; }
        .property-view-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin:20px 0; }
        .property-view-row { background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:12px; }
        .property-view-label { color:#475569; font-size:13px; margin-bottom:4px; }
        .property-view-value { color:#0f172a; font-weight:600; font-size:14px; }
        .property-view-description { background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:12px; margin:20px 0; }
        .property-view-author { font-size:14px; color:#64748b; margin-top:16px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; display:flex; align-items:center; gap:8px; }
        .property-view-author-name { font-weight:600; color:#334155; }
        .property-view-author-badge { padding:3px 8px; border-radius:4px; background:#dbeafe; color:#1e40af; font-size:11px; }
        .property-view-close { position:absolute; top:12px; right:12px; width:32px; height:32px; border-radius:50%; background:#fff; border:1px solid #e2e8f0; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; color:#64748b; z-index:10; }
        .property-view-close:hover { background:#f8fafc; }
        .property-view-chat-btn { padding:10px 20px; border-radius:6px; background:#2563eb; color:#fff; border:none; cursor:pointer; font-size:14px; margin-top:12px; }
        .property-view-chat-btn:hover { background:#1e40af; }
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .property-view-key-features { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin:20px 0; }
        .property-view-key-feature { display:flex; align-items:center; gap:8px; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; }
        .property-view-key-feature-icon { font-size:20px; }
        .property-view-key-feature-text { display:flex; flex-direction:column; }
        .property-view-key-feature-label { font-size:11px; color:#64748b; }
        .property-view-key-feature-value { font-size:14px; font-weight:600; color:#0f172a; }
        .property-view-section { margin:24px 0; }
        .property-view-section-title { font-size:18px; font-weight:700; color:#0f172a; margin:0 0 16px; }
        .property-view-section-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
        .property-view-utilities { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin:16px 0; }
        .property-view-utility { display:flex; justify-content:space-between; padding:8px 12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; }
        .property-view-utility-label { font-size:13px; color:#475569; }
        .property-view-utility-value { font-size:13px; font-weight:600; color:#0f172a; }
        .property-view-amenities { display:flex; flex-wrap:wrap; gap:6px; margin:12px 0; }
        .property-view-amenity { padding:6px 12px; background:#eff6ff; color:#1e40af; border-radius:999px; font-size:12px; }
        .chats-badge { display:inline-block; min-width:18px; height:18px; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-size:11px; font-weight:700; line-height:18px; text-align:center; margin-left:6px; }
        @media (max-width: 860px) { .property-view-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <div class="brand">
                <div class="logo">üè†</div>
                <div>RealEstate</div>
            </div>
            <a th:href="@{/chats}" class="back" id="chats-link">
                ‚Üê –ö —á–∞—Ç–∞–º
                <span id="chats-badge" class="chats-badge" style="display:none;">0</span>
            </a>
        </div>

        <div class="chat-header">
            <h2>–ß–∞—Ç –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é: 
                <a href="javascript:void(0);" class="property-link" th:onclick="|openPropertyView(${property.id})|">
                    <span th:text="${property.address}">–ê–¥—Ä–µ—Å</span>
                    <span th:if="${property.city != null and !property.city.isEmpty()}" th:text="|, ${property.city}|">, –ì–æ—Ä–æ–¥</span>
                    <span th:if="${property.rooms != null}" th:text="| ¬∑ ${property.rooms} –∫–æ–º–Ω|"> ¬∑ –ö–æ–º–Ω–∞—Ç—ã</span>
                    <span th:if="${property.price != null}" th:text="| ¬∑ ${#numbers.formatDecimal(property.price, 0, 'COMMA', 0, 'POINT')} ‚ÇΩ|"> ¬∑ –¶–µ–Ω–∞</span>
                </a>
            </h2>
            <p th:text="|–° ${otherUser.firstName != null ? otherUser.firstName + ' ' + (otherUser.lastName != null ? otherUser.lastName : '') : otherUser.email}|">–° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</p>
        </div>

        <div id="messages" class="messages">
            <div th:each="msg : ${messages}" class="message" th:classappend="${msg.user.id == currentUser.id} ? 'own' : ''">
                <div class="message-avatar" th:text="${#strings.substring(msg.user.firstName != null ? msg.user.firstName : msg.user.email, 0, 1).toUpperCase()}">U</div>
                <div class="message-content">
                    <div class="message-author" th:text="${msg.user.firstName != null ? msg.user.firstName + ' ' + (msg.user.lastName != null ? msg.user.lastName : '') : msg.user.email}">–ê–≤—Ç–æ—Ä</div>
                    <div class="message-bubble">
                        <p class="message-text" th:text="${msg.messageText}">–°–æ–æ–±—â–µ–Ω–∏–µ</p>
                    </div>
                    <div class="message-time" th:text="${#temporals.format(msg.sentDate, 'dd.MM.yyyy HH:mm')}">–í—Ä–µ–º—è</div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
            <button onclick="sendMessage()" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <button th:if="${chat != null and currentUser != null and chat.seller != null and chat.seller.id == currentUser.id}"
                    onclick="sendContract()" id="sendContractBtn" style="background:#0f172a">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä</button>
        </div>
    </div>

    <script th:inline="javascript">
        const chatId = /*[[${chat.id}]]*/ 0;
        const currentUserId = /*[[${currentUser.id}]]*/ 0;
        const isNewEmptyChat = /*[[${isNewEmptyChat != null ? isNewEmptyChat : false}]]*/ false;
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        let hasMessages = /*[[${messages != null && !messages.isEmpty()}]]*/ false;

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;

            sendBtn.disabled = true;
            fetch(`/v1/api/chat/${chatId}/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messageText: text })
            })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + res.status + ' - ' + text);
                    });
                }
                return res.json();
            })
            .then(data => {
                messageInput.value = '';
                hasMessages = true; // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ –≤ —á–∞—Ç–µ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
                loadMessages(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: ' + err.message);
            })
            .finally(() => {
                sendBtn.disabled = false;
            });
        }

        function sendContract() {
            const btn = document.getElementById('sendContractBtn');
            if (btn) btn.disabled = true;
            fetch(`/v1/api/chat/${chatId}/send-contract`, { method: 'POST' })
                .then(res => {
                    if (!res.ok) {
                        return res.json().catch(() => ({})).then(data => { throw new Error(data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–≥–æ–≤–æ—Ä–∞'); });
                    }
                    return res.json();
                })
                .then(data => {
                    alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ —á–∞—Ç');
                    loadMessages(true);
                })
                .catch(err => {
                    alert(err.message);
                })
                .finally(() => { if (btn) btn.disabled = false; });
        }

        let lastMessageCount = 0;
        let shouldScrollToBottom = true;
        
        function loadMessages(forceScrollToBottom = false) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–Ω–∏–∑—É —á–∞—Ç–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
            const isAtBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop - messagesDiv.clientHeight < 100;
            const wasAtBottom = shouldScrollToBottom || isAtBottom;
            
            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            fetch(`/v1/api/chat/${chatId}/messages`)
                .then(res => {
                    if (!res.ok) {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', res.status);
                        return [];
                    }
                    return res.json();
                })
                .then(messages => {
                    if (!messages || messages.length === 0) {
                        messagesDiv.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    const hasNewMessages = messages.length > lastMessageCount;
                    lastMessageCount = messages.length;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                    const oldScrollTop = messagesDiv.scrollTop;
                    const oldScrollHeight = messagesDiv.scrollHeight;
                    
                    function linkify(safeText) {
                        // –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
                        // /deal/{id}
                        safeText = safeText.replace(/(\/deal\/\d+)/g, '<a href="$1" target="_blank" style="color:#1e40af;text-decoration:underline;">$1<\/a>');
                        // http/https —Å—Å—ã–ª–∫–∏
                        safeText = safeText.replace(/\bhttps?:\/\/[^\s<>"]+/g, function(url){
                            return '<a href="' + url + '" target="_blank" rel="noopener" style="color:#1e40af;text-decoration:underline;">' + url + '<\/a>';
                        });
                        return safeText;
                    }

                    messagesDiv.innerHTML = messages.map(msg => {
                        const isOwn = msg.userId === currentUserId;
                        const authorName = msg.userFirstName ? `${msg.userFirstName} ${msg.userLastName || ''}`.trim() : msg.userEmail;
                        const authorInitial = authorName ? authorName.charAt(0).toUpperCase() : 'U';
                        const date = new Date(msg.sentDate);
                        const dateStr = date.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ" –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–æ—á–∏—Ç–∞–Ω—ã —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º
                        const readIndicator = isOwn && msg.read ? '<div class="message-read">–ü—Ä–æ—á–∏—Ç–∞–Ω–æ</div>' : '';
                        const safeText = (msg.messageText || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const linkedText = linkify(safeText);
                        return `
                            <div class="message ${isOwn ? 'own' : ''}">
                                <div class="message-avatar">${authorInitial}</div>
                                <div class="message-content">
                                    <div class="message-author">${authorName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                                    <div class="message-bubble">
                                        <p class="message-text">${linkedText}</p>
                                    </div>
                                    <div class="message-time">${dateStr}</div>
                                    ${readIndicator}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏:
                    // 1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—ã–ª –≤–Ω–∏–∑—É –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                    // 2. –ï—Å—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    // 3. –Ø–≤–Ω–æ –∑–∞–ø—Ä–æ—à–µ–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                    if (forceScrollToBottom || (wasAtBottom && hasNewMessages)) {
                        messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        shouldScrollToBottom = true;
                    } else {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                        const newScrollHeight = messagesDiv.scrollHeight;
                        const scrollDiff = newScrollHeight - oldScrollHeight;
                        messagesDiv.scrollTop = oldScrollTop + scrollDiff;
                        shouldScrollToBottom = false;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –¥–∞—Ç—å –≤—Ä–µ–º—è –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
                    setTimeout(() => {
                        updateUnreadIndicators();
                    }, 300);
                })
                .catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', err);
                });
        }
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        messagesDiv.addEventListener('scroll', function() {
            const isAtBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop - messagesDiv.clientHeight < 100;
            shouldScrollToBottom = isAtBottom;
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –û—Ç–º–µ—á–∞–µ–º —á–∞—Ç –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
        async function markChatAsReadAndUpdate() {
            try {
                const response = await fetch(`/v1/api/chat/${chatId}/mark-read`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —á–∞—Ç–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ:', response.status);
                    return;
                }
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                await new Promise(resolve => setTimeout(resolve, 300));
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                await updateUnreadIndicators();
                await new Promise(resolve => setTimeout(resolve, 200));
                await updateUnreadIndicators();
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
                loadMessages(true); // –ü—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —á–∞—Ç–∞ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ:', err);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        async function updateUnreadIndicators() {
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ß–∞—Ç—ã" —á–µ—Ä–µ–∑ API
                const res = await fetch('/v1/api/chat/unread-count');
                if (res.ok) {
                    const data = await res.json();
                    const unreadCount = data.unreadCount || 0;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ß–∞—Ç—ã" (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
                    const badge = document.getElementById('chats-badge');
                    if (badge) {
                        if (unreadCount > 0) {
                            badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                    
                    // –í—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
                    if (typeof window.checkUnreadMessages === 'function') {
                        window.checkUnreadMessages();
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤, –µ—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤
                if (typeof loadChats === 'function') {
                    loadChats();
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤:', err);
            }
        }
        
        // –û—Ç–º–µ—á–∞–µ–º —á–∞—Ç –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–π —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º DOMContentLoaded –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–∞
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', markChatAsReadAndUpdate);
        } else {
            markChatAsReadAndUpdate();
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
        setInterval(() => loadMessages(false), 3000);
        
        // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–π —á–∞—Ç –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω
        window.addEventListener('beforeunload', function() {
            if (isNewEmptyChat && !hasMessages && chatId) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch —Å keepalive –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                fetch(`/v1/api/chat/${chatId}`, { 
                    method: 'DELETE',
                    keepalive: true
                }).catch(() => {});
            }
        });
        
        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –¥—Ä—É–≥—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden' && isNewEmptyChat && !hasMessages && chatId) {
                fetch(`/v1/api/chat/${chatId}`, { method: 'DELETE' }).catch(() => {});
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫—É "–ö —á–∞—Ç–∞–º"
        const backLink = document.querySelector('.back');
        if (backLink) {
            backLink.addEventListener('click', function(e) {
                if (isNewEmptyChat && !hasMessages && chatId) {
                    e.preventDefault();
                    fetch(`/v1/api/chat/${chatId}`, { method: 'DELETE' })
                        .then(() => {
                            window.location.href = '/chats';
                        })
                        .catch(() => {
                            window.location.href = '/chats';
                        });
                }
            });
        }
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        async function openPropertyView(propertyId) {
            try {
                const res = await fetch('/v1/api/properties/' + propertyId);
                if (!res.ok) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ');
                    return;
                }
                const property = await res.json();
                
                const modal = document.getElementById('property-view-modal');
                if (!modal) {
                    console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                
                const titleEl = modal.querySelector('.property-view-title');
                const priceEl = modal.querySelector('.property-view-price');
                const galleryEl = modal.querySelector('.property-view-gallery');
                const keyFeaturesEl = modal.querySelector('.property-view-key-features');
                const contentEl = modal.querySelector('.property-view-content-details');
                const descriptionEl = modal.querySelector('.property-view-description-text');
                const authorEl = modal.querySelector('.property-view-author-info');
                const chatBtnEl = modal.querySelector('.property-view-chat-btn');
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ü–µ–Ω—É
                const propertyType = property.type || '';
                const propertyTitle = propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' 
                    ? `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : propertyType === '–¥–æ–º'
                    ? `–î–æ–º ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è'
                    ? `–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : property.address || '–û–±—ä—è–≤–ª–µ–Ω–∏–µ';
                
                if (titleEl) titleEl.textContent = propertyTitle;
                if (priceEl) priceEl.textContent = property.price ? new Intl.NumberFormat('ru-RU').format(property.price) + ' ‚ÇΩ' : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                
                // –ì–∞–ª–µ—Ä–µ—è
                if (galleryEl) {
                    const imageUrls = property.imageUrls ? property.imageUrls.split(',').map(url => url.trim()).filter(url => url) : [];
                    if (imageUrls.length === 0) {
                        galleryEl.innerHTML = '<img src="https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop" alt="placeholder" />';
                        galleryEl.classList.add('single');
                    } else {
                        galleryEl.innerHTML = imageUrls.map(url => `<img src="${url}" alt="photo" onerror="this.src=\'https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop\'" />`).join('');
                        galleryEl.classList.toggle('single', imageUrls.length === 1);
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                if (keyFeaturesEl) {
                    const features = [];
                    if (property.area) features.push({icon: 'üìê', label: '–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å', value: property.area + ' –º¬≤'});
                    if (propertyType === '–¥–æ–º' && property.plotArea) features.push({icon: 'üèûÔ∏è', label: '–£—á–∞—Å—Ç–æ–∫', value: property.plotArea + ' —Å–æ—Ç.'});
                    if (propertyType === '–¥–æ–º' && property.buildingMaterial) features.push({icon: 'üèóÔ∏è', label: '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–º–∞', value: property.buildingMaterial});
                    if (propertyType === '–¥–æ–º' && property.floorsTotal) features.push({icon: 'ü™ú', label: '–≠—Ç–∞–∂–µ–π –≤ –¥–æ–º–µ', value: property.floorsTotal});
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.floor && property.floorsTotal) features.push({icon: 'ü™ú', label: '–≠—Ç–∞–∂', value: property.floor + ' –∏–∑ ' + property.floorsTotal});
                    if (property.yearBuilt) features.push({icon: 'üìÖ', label: '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', value: property.yearBuilt});
                    if (propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' && property.propertyClass) features.push({icon: '‚≠ê', label: '–ö–ª–∞—Å—Å', value: property.propertyClass});
                    if (property.parking) features.push({icon: 'üÖøÔ∏è', label: '–ü–∞—Ä–∫–æ–≤–∫–∞', value: property.parking});
                    
                    if (features.length > 0) {
                        keyFeaturesEl.innerHTML = features.map(f => `
                            <div class="property-view-key-feature">
                                <div class="property-view-key-feature-icon">${f.icon}</div>
                                <div class="property-view-key-feature-text">
                                    <div class="property-view-key-feature-label">${f.label}</div>
                                    <div class="property-view-key-feature-value">${f.value}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        keyFeaturesEl.innerHTML = '';
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (contentEl) {
                    let html = '';
                    
                    // –°–µ–∫—Ü–∏—è "–û –∫–≤–∞—Ä—Ç–∏—Ä–µ" / "–û –¥–æ–º–µ" / "–û–± –æ–±—ä–µ–∫—Ç–µ"
                    const sectionTitle = propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' ? '–û –∫–≤–∞—Ä—Ç–∏—Ä–µ' 
                        : propertyType === '–¥–æ–º' ? '–û –¥–æ–º–µ' 
                        : '–û–± –æ–±—ä–µ–∫—Ç–µ';
                    
                    html += `<div class="property-view-section">
                        <div class="property-view-section-title">${sectionTitle}</div>
                        <div class="property-view-section-grid">`;
                    
                    if (property.area) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å</div><div class="property-view-value">${property.area} –º¬≤</div></div>`;
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.kitchenArea) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏</div><div class="property-view-value">${property.kitchenArea} –º¬≤</div></div>`;
                    if (property.rooms) html += `<div class="property-view-row"><div class="property-view-label">–ö–æ–º–Ω–∞—Ç</div><div class="property-view-value">${property.rooms}</div></div>`;
                    if (propertyType === '–¥–æ–º' && property.bedrooms) html += `<div class="property-view-row"><div class="property-view-label">–°–ø–∞–ª–µ–Ω</div><div class="property-view-value">${property.bedrooms}</div></div>`;
                    if (property.bathrooms) html += `<div class="property-view-row"><div class="property-view-label">–°–∞–Ω—É–∑–µ–ª</div><div class="property-view-value">${property.bathrooms} ${property.bathrooms === 1 ? '—Ä–∞–∑–¥–µ–ª—å–Ω—ã–π' : '—Ä–∞–∑–¥–µ–ª—å–Ω—ã—Ö'}</div></div>`;
                    if (property.buildingMaterial) html += `<div class="property-view-row"><div class="property-view-label">–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–º–∞</div><div class="property-view-value">${property.buildingMaterial}</div></div>`;
                    if (property.condition) html += `<div class="property-view-row"><div class="property-view-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div><div class="property-view-value">${property.condition}</div></div>`;
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.windowView) html += `<div class="property-view-row"><div class="property-view-label">–í–∏–¥ –∏–∑ –æ–∫–æ–Ω</div><div class="property-view-value">${property.windowView}</div></div>`;
                    if (property.renovation) html += `<div class="property-view-row"><div class="property-view-label">–†–µ–º–æ–Ω—Ç</div><div class="property-view-value">${property.renovation}</div></div>`;
                    if (property.furnished !== null && property.furnished !== undefined) html += `<div class="property-view-row"><div class="property-view-label">–ü—Ä–æ–¥–∞—ë—Ç—Å—è —Å –º–µ–±–µ–ª—å—é</div><div class="property-view-value">${property.furnished ? '–î–∞' : '–ù–µ—Ç'}</div></div>`;
                    if (property.category) html += `<div class="property-view-row"><div class="property-view-label">–¢–∏–ø –∂–∏–ª—å—è</div><div class="property-view-value">${property.category}</div></div>`;
                    
                    html += `</div></div>`;
                    
                    // –°–µ–∫—Ü–∏—è "–û–± —É—á–∞—Å—Ç–∫–µ" (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–º–æ–≤)
                    if (propertyType === '–¥–æ–º' && (property.plotArea || property.landCategory)) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–û–± —É—á–∞—Å—Ç–∫–µ</div>
                            <div class="property-view-section-grid">`;
                        if (property.plotArea) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å</div><div class="property-view-value">${property.plotArea} —Å–æ—Ç.</div></div>`;
                        if (property.landCategory) html += `<div class="property-view-row"><div class="property-view-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å</div><div class="property-view-value">${property.landCategory}</div></div>`;
                        html += `</div></div>`;
                    }
                    
                    // –°–µ–∫—Ü–∏—è "–û –¥–æ–º–µ" (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä)
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && (property.yearBuilt || property.buildingMaterial || property.floorsTotal || property.parking)) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–û –¥–æ–º–µ</div>
                            <div class="property-view-section-grid">`;
                        if (property.yearBuilt) html += `<div class="property-view-row"><div class="property-view-label">–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</div><div class="property-view-value">${property.yearBuilt}</div></div>`;
                        if (property.buildingMaterial) html += `<div class="property-view-row"><div class="property-view-label">–¢–∏–ø –¥–æ–º–∞</div><div class="property-view-value">${property.buildingMaterial}</div></div>`;
                        if (property.floorsTotal) html += `<div class="property-view-row"><div class="property-view-label">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</div><div class="property-view-value">${property.floorsTotal}</div></div>`;
                        if (property.parking) html += `<div class="property-view-row"><div class="property-view-label">–ü–∞—Ä–∫–æ–≤–∫–∞</div><div class="property-view-value">${property.parking}</div></div>`;
                        html += `</div></div>`;
                    }
                    
                    // –°–µ–∫—Ü–∏—è "–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞"
                    if (property.heating || property.waterSupply || property.sewerage || property.gas || property.electricity || property.amenities) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞</div>
                            <div class="property-view-utilities">`;
                        if (property.heating) html += `<div class="property-view-utility"><span class="property-view-utility-label">–û—Ç–æ–ø–ª–µ–Ω–∏–µ</span><span class="property-view-utility-value">${property.heating}</span></div>`;
                        if (property.waterSupply) html += `<div class="property-view-utility"><span class="property-view-utility-label">–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ</span><span class="property-view-utility-value">${property.waterSupply}</span></div>`;
                        if (property.sewerage) html += `<div class="property-view-utility"><span class="property-view-utility-label">–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è</span><span class="property-view-utility-value">${property.sewerage}</span></div>`;
                        if (property.gas) html += `<div class="property-view-utility"><span class="property-view-utility-label">–ì–∞–∑</span><span class="property-view-utility-value">${property.gas}</span></div>`;
                        if (property.electricity) html += `<div class="property-view-utility"><span class="property-view-utility-label">–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ</span><span class="property-view-utility-value">${property.electricity}</span></div>`;
                        html += `</div>`;
                        if (property.amenities) {
                            const amenitiesList = property.amenities.split(',').map(a => a.trim()).filter(a => a);
                            if (amenitiesList.length > 0) {
                                html += `<div class="property-view-amenities">`;
                                amenitiesList.forEach(amenity => {
                                    html += `<span class="property-view-amenity">${amenity}</span>`;
                                });
                                html += `</div>`;
                            }
                        }
                        html += `</div>`;
                    }
                    
                    contentEl.innerHTML = html;
                }
                
                if (descriptionEl) {
                    descriptionEl.innerHTML = property.description && property.description.trim() ? property.description : '‚Äî';
                }
                
                if (authorEl) {
                    const authorName = property.authorFirstName 
                        ? `${property.authorFirstName} ${property.authorLastName || ''}`.trim()
                        : property.authorEmail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    authorEl.innerHTML = `
                        <span>–ê–≤—Ç–æ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è:</span>
                        <span class="property-view-author-name">${authorName}</span>
                        ${property.isRealtor ? '<span class="property-view-author-badge">–†–∏–µ–ª—Ç–æ—Ä</span>' : ''}
                    `;
                }
                
                if (chatBtnEl) {
                    chatBtnEl.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–≤—è–∑–∞—Ç—å—Å—è" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ, —Ç–∞–∫ –∫–∞–∫ –º—ã —É–∂–µ –≤ —á–∞—Ç–µ
                }
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.classList.add('open');
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
                document.body.style.overflow = 'hidden';
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ');
            }
        }
        
        function closePropertyView() {
            const modal = document.getElementById('property-view-modal');
            if (modal) {
                modal.classList.remove('open');
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
                document.body.style.overflow = '';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('property-view-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePropertyView();
                    }
                });
            }
        });
    </script>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
    <div id="property-view-modal" class="property-view-modal">
        <div class="property-view-card">
            <button class="property-view-close" onclick="closePropertyView()">√ó</button>
            <div class="property-view-gallery">
                <!-- –ì–∞–ª–µ—Ä–µ—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <div class="property-view-content">
                <div class="property-view-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="property-view-price">‚Äî</div>
                <div class="property-view-key-features">
                    <!-- –ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="property-view-content-details">
                    <!-- –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="property-view-description">
                    <div class="property-view-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    <div class="property-view-value property-view-description-text">‚Äî</div>
                </div>
                <div class="property-view-author property-view-author-info">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <button class="property-view-chat-btn" style="display:none;">–°–≤—è–∑–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>
</body>
</html>

