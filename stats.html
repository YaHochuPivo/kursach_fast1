<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂ ‚Äî RealEstate</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin:0; font-family: Arial, Helvetica, sans-serif; color:#0f172a; background:#ffffff; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
        .nav { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid #dbeafe; }
        .brand { display:flex; align-items:center; gap:10px; font-weight:700; color:#1e293b; }
        .brand .logo { width:30px; height:30px; display:grid; place-items:center; border-radius:6px; background:#2563eb; color:#fff; font-size:16px; }
        .nav-links { display:flex; align-items:center; gap:10px; }
        .nav-links a { text-decoration:none; color:#1f2937; padding:6px 10px; border-radius:6px; }
        .nav-links a:hover { background:#eff6ff; }
        .btn { display:inline-block; padding:8px 12px; border-radius:6px; text-decoration:none; font-weight:600; border:1px solid #dbeafe; background:#ffffff; color:#1e293b; }
        .page-title { margin:20px 0 10px; font-size:24px; font-weight:700; color:#0f172a; }
        .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px; margin:20px 0; }
        .stat-card { background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:16px; }
        .stat-card h3 { margin:0 0 8px; font-size:14px; color:#64748b; font-weight:600; }
        .stat-card .value { font-size:28px; font-weight:700; color:#0f172a; }
        .stat-card .label { font-size:12px; color:#64748b; margin-top:4px; }
        .chart-container { background:#fff; border:1px solid #e2e8f0; border-radius:8px; padding:20px; margin:20px 0; }
        .chart-title { margin:0 0 16px; font-size:18px; font-weight:700; color:#0f172a; }
    </style>
</head>
<body>
    <header class="container nav">
        <div class="brand">
            <div class="logo">üè†</div>
            <div>RealEstate</div>
        </div>
        <div class="nav-links">
            <a th:href="@{/}">–ì–ª–∞–≤–Ω–∞—è</a>
            <a th:href="@{/properties}">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</a>
            <a th:href="@{/realtor/stats}" class="btn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìä</a>
            <a th:href="@{/user/profile}" class="btn">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a th:href="@{/logout}" class="btn">–í—ã–π—Ç–∏</a>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</h1>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ —Å–¥–µ–ª–æ–∫</h3>
                <div class="value" id="totalDeals">0</div>
                <div class="label">–í—Å–µ —Å–¥–µ–ª–∫–∏</div>
            </div>
            <div class="stat-card">
                <h3>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</h3>
                <div class="value" id="completedDeals">0</div>
                <div class="label">–£—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã–µ</div>
            </div>
            <div class="stat-card">
                <h3>–í –æ–∂–∏–¥–∞–Ω–∏–∏</h3>
                <div class="value" id="pendingDeals">0</div>
                <div class="label">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</div>
            </div>
            <div class="stat-card">
                <h3>–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ</h3>
                <div class="value" id="cancelledDeals">0</div>
                <div class="label">–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏</div>
            </div>
            <div class="stat-card">
                <h3>–û–±—â–∏–π –¥–æ—Ö–æ–¥</h3>
                <div class="value" id="totalRevenue">0 ‚ÇΩ</div>
                <div class="label">–û—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–¥–µ–ª–æ–∫</div>
            </div>
            <div class="stat-card">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
                <div class="value" id="activeProperties">0</div>
                <div class="label">–í—Å–µ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–π</div>
            </div>
            <div class="stat-card">
                <h3>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ</h3>
                <div class="value" id="promotedProperties">0</div>
                <div class="label">–° –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ–º</div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">–ü—Ä–æ–¥–∞–∂–∏ –ø–æ –º–µ—Å—è—Ü–∞–º</h2>
            <canvas id="salesChart"></canvas>
        </div>
    </main>

    <script>
        async function loadStats() {
            try {
                const res = await fetch('/v1/api/realtor/stats');
                if (!res.ok) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                    return;
                }
                const data = await res.json();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                document.getElementById('totalDeals').textContent = data.totalDeals || 0;
                document.getElementById('completedDeals').textContent = data.completedDeals || 0;
                document.getElementById('pendingDeals').textContent = data.pendingDeals || 0;
                document.getElementById('cancelledDeals').textContent = data.cancelledDeals || 0;
                document.getElementById('totalRevenue').textContent = new Intl.NumberFormat('ru-RU').format(data.totalRevenue || 0) + ' ‚ÇΩ';
                document.getElementById('activeProperties').textContent = data.activeProperties || 0;
                document.getElementById('promotedProperties').textContent = data.promotedProperties || 0;
                
                // –°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ–∏–∫
                const monthlyStats = data.monthlyStats || {};
                const months = Object.keys(monthlyStats).sort().reverse();
                const counts = months.map(m => monthlyStats[m] || 0);
                
                const ctx = document.getElementById('salesChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months.map(m => {
                            const [year, month] = m.split('-');
                            const monthNames = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
                            return monthNames[parseInt(month) - 1] + ' ' + year;
                        }),
                        datasets: [{
                            label: '–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —Å–¥–µ–ª–∫–∏',
                            data: counts,
                            backgroundColor: '#2563eb',
                            borderColor: '#1d4ed8',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', e);
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadStats);
    </script>
</body>
</html>

