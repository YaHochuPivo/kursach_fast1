<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–≥–æ–≤–æ—Ä –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏</title>
    <style>
        body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#ffffff; color:#0f172a; }
        .container { max-width: 900px; margin: 0 auto; padding: 16px; }
        .nav { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid #dbeafe; }
        .brand { display:flex; align-items:center; gap:10px; font-weight:700; color:#1e293b; }
        .brand .logo { width:30px; height:30px; display:grid; place-items:center; border-radius:6px; background:#2563eb; color:#fff; font-size:16px; }
        .nav-links { display:flex; align-items:center; gap:10px; }
        .nav-links a { text-decoration:none; color:#1f2937; padding:6px 10px; border-radius:6px; }
        .nav-links a:hover { background:#eff6ff; }
        .title { text-align:center; font-weight:800; font-size:20px; margin:8px 0 16px; }
        .section { margin:12px 0; }
        .row { display:flex; gap:8px; margin:6px 0; }
        .label { min-width:180px; color:#64748b; }
        .val { font-weight:600; }
        .actions { display:flex; gap:10px; margin-top:20px; }
        .btn { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
        .btn-primary { background:#16a34a; color:#fff; }
        .btn-secondary { background:#ef4444; color:#fff; }
        .btn-outline { background:#fff; border:1px solid #cbd5e1; color:#0f172a; text-decoration:none; display:inline-block; }
        .muted { color:#64748b; font-size:12px; }
        .card { border:1px solid #e2e8f0; border-radius:8px; padding:16px; background:#fff; }
        .grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
        @media (max-width: 720px) { .grid { grid-template-columns: 1fr; } .label{min-width:120px;} }
    </style>
</head>
<body>
<header class="container nav">
    <div class="brand">
        <div class="logo">üè†</div>
        <div>RealEstate</div>
    </div>
    <div class="nav-links">
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/properties">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</a>
        <a href="/deals">–ú–æ–∏ —Å–¥–µ–ª–∫–∏</a>
        <a href="/chats">–ß–∞—Ç—ã</a>
        <a href="/user/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
    </div>
</header>
<div class="container">
    <div class="title">–î–û–ì–û–í–û–† –ö–£–ü–õ–ò-–ü–†–û–î–ê–ñ–ò</div>

    <div class="card section" th:if="${isPrivateSeller}">
        <div class="row" style="align-items:center; justify-content:space-between;">
            <div>
                <div class="label" style="min-width:auto; margin-bottom:6px;">–°—Ç–∞—Ç—É—Å –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–∏—è</div>
                <div class="val" th:text="${bankApprovalStatus == null ? '–ù–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ' : (bankApprovalStatus == 'REQUESTED' ? '–ó–∞–ø—Ä–æ—à–µ–Ω–æ' : (bankApprovalStatus == 'APPROVED' ? '–û–¥–æ–±—Ä–µ–Ω–æ' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'))}">‚Äî</div>
                <div class="muted" th:if="${bankName != null}">–ë–∞–Ω–∫: <span th:text="${bankName}">–ë–∞–Ω–∫</span></div>
            </div>
            <div class="actions">
                <button class="btn btn-outline" type="button" th:if="${bankApprovalStatus == null}" onclick="requestBankApproval()">–ó–∞–ø—Ä–æ—Å–∏—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏–µ</button>
                <button class="btn btn-outline" type="button" th:if="${bankApprovalStatus == 'REQUESTED'}" onclick="refreshBankApproval()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
                <button class="btn btn-outline" type="button" th:if="${bankApprovalStatus == 'REQUESTED'}" onclick="setBankApprovalStatus('APPROVED')">–û–¥–æ–±—Ä–∏—Ç—å</button>
                <button class="btn btn-outline" type="button" th:if="${bankApprovalStatus == 'REQUESTED'}" onclick="setBankApprovalStatus('REJECTED')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
        </div>
        <div class="muted" style="margin-top:8px;" th:if="${bankApprovalStatus != 'APPROVED'}">–ß–∞—Å—Ç–Ω—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è –±–∞–Ω–∫–∞.</div>
    </div>

    <div class="card section">
        <div class="grid">
            <div>
                <div class="row"><div class="label">–ü—Ä–æ–¥–∞–≤–µ—Ü</div><div class="val" th:text="${seller != null ? (seller.firstName + ' ' + (seller.lastName != null ? seller.lastName : '')) : '‚Äî'}">‚Äî</div></div>
                <div class="row"><div class="label">Email</div><div class="val" th:text="${seller != null ? seller.email : '‚Äî'}">‚Äî</div></div>
            </div>
            <div>
                <div class="row"><div class="label">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</div><div class="val" th:text="${buyer != null ? (buyer.firstName + ' ' + (buyer.lastName != null ? buyer.lastName : '')) : '‚Äî'}">‚Äî</div></div>
                <div class="row"><div class="label">Email</div><div class="val" th:text="${buyer != null ? buyer.email : '‚Äî'}">‚Äî</div></div>
            </div>
        </div>
        <div class="grid" style="margin-top:8px;">
            <div>
                <div class="row"><div class="label">–ü–∞—Å–ø–æ—Ä—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞</div><div class="val" th:text="${seller != null ? ((seller.passportSeries != null ? seller.passportSeries : '‚Äî') + ' ' + (seller.passportNumber != null ? seller.passportNumber : '‚Äî')) : '‚Äî'}">‚Äî</div></div>
            </div>
            <div>
                <div class="row"><div class="label">–ü–∞—Å–ø–æ—Ä—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è</div><div class="val" th:text="${buyer != null ? ((buyer.passportSeries != null ? buyer.passportSeries : '‚Äî') + ' ' + (buyer.passportNumber != null ? buyer.passportNumber : '‚Äî')) : '‚Äî'}">‚Äî</div></div>
            </div>
        </div>
        <div class="row" style="margin-top:8px;">
            <div class="label">–†–∏–µ–ª—Ç–æ—Ä</div>
            <div class="val" th:text="${realtor != null ? (realtor.firstName + ' ' + (realtor.lastName != null ? realtor.lastName : '')) : '‚Äî'}">‚Äî</div>
        </div>
    </div>

    <div class="card section">
        <div class="row"><div class="label">–û–±—ä–µ–∫—Ç</div><div class="val" th:text="${property != null ? (property.type != null ? property.type : '–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å') : '–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å'}">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</div></div>
        <div class="row"><div class="label">–ê–¥—Ä–µ—Å</div><div class="val" th:text="${property != null ? property.address : '‚Äî'}">‚Äî</div></div>
        <div class="row"><div class="label">–°—É–º–º–∞</div><div class="val" th:text="${deal != null && deal.finalPrice != null ? #numbers.formatDecimal(deal.finalPrice, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ' : (property != null && property.price != null ? #numbers.formatDecimal(property.price, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ' : '‚Äî')}">‚Äî</div></div>
        <div class="grid" style="margin-top:8px;">
            <div class="row"><div class="label">–ì–æ—Ä–æ–¥</div><div class="val" th:text="${property != null ? (property.city != null ? property.city : '‚Äî') : '‚Äî'}">‚Äî</div></div>
            <div class="row"><div class="label">–†–∞–π–æ–Ω</div><div class="val" th:text="${property != null ? (property.district != null ? property.district : '‚Äî') : '‚Äî'}">‚Äî</div></div>
            <div class="row"><div class="label">–≠—Ç–∞–∂/–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</div><div class="val" th:text="${property != null ? ((property.floor != null ? property.floor : '‚Äî') + ' / ' + (property.floorsTotal != null ? property.floorsTotal : '‚Äî')) : '‚Äî'}">‚Äî</div></div>
            <div class="row"><div class="label">–ü–ª–æ—â–∞–¥—å</div><div class="val" th:text="${property != null && property.area != null ? property.area + ' –º¬≤' : '‚Äî'}">‚Äî</div></div>
            <div class="row"><div class="label">–ö–æ–º–Ω–∞—Ç</div><div class="val" th:text="${property != null && property.rooms != null ? property.rooms : '‚Äî'}">‚Äî</div></div>
            <div class="row"><div class="label">–°—Ç–∞—Ç—É—Å —Å–¥–µ–ª–∫–∏</div><div class="val" th:text="${deal != null ? (deal.status.name()=='completed' ? '–ó–∞–≤–µ—Ä—à–µ–Ω–∞' : (deal.status.name()=='pending' ? '–û–∂–∏–¥–∞–µ—Ç —Ä–µ—à–µ–Ω–∏—è' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞')) : '‚Äî'}">‚Äî</div></div>
            <div class="row" th:if="${deal != null && deal.dealDate != null}"><div class="label">–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è</div><div class="val" th:text="${#temporals.format(deal.dealDate, 'dd.MM.yyyy HH:mm')}">‚Äî</div></div>
        </div>
    </div>

    <div class="card section">
        <div class="title" style="font-weight:700;margin-bottom:8px;text-align:left;">–ò–ø–æ—Ç–µ–∫–∞</div>
        <div class="row" th:if="${mortgageStatus != null}">
            <div class="label">–°—Ç–∞—Ç—É—Å –∏–ø–æ—Ç–µ–∫–∏</div>
            <div class="val" th:text="${mortgageStatus == 'REQUESTED' ? '–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞' : (mortgageStatus == 'APPROVED' ? '–û–¥–æ–±—Ä–µ–Ω–∞' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞')}">‚Äî</div>
        </div>
        <div class="row" th:if="${mortgageBankName != null}"><div class="label">–ë–∞–Ω–∫</div><div class="val" th:text="${mortgageBankName}">–ë–∞–Ω–∫</div></div>
        <div class="row" th:if="${mortgageMonthlyPayment != null}"><div class="label">–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç—ë–∂</div><div class="val" th:text="${#numbers.formatDecimal(mortgageMonthlyPayment, 2, 'COMMA', 2, 'POINT') + ' ‚ÇΩ'}">‚Äî</div></div>
        <div class="muted" th:if="${mortgageStatus != null}" style="margin-top:6px;">–°–¥–µ–ª–∫–∞ –æ—Ñ–æ—Ä–º–ª—è–µ—Ç—Å—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–ø–æ—Ç–µ—á–Ω–æ–≥–æ –∫—Ä–µ–¥–∏—Ç–æ–≤–∞–Ω–∏—è.</div>

        <div class="actions" th:if="${mortgageStatus == null and buyer != null and currentUserEmail != null and currentUserEmail.equals(buyer.email)}">
            <button class="btn btn-outline" type="button" onclick="applyMortgage()">–û—Ñ–æ—Ä–º–∏—Ç—å –∏–ø–æ—Ç–µ–∫—É</button>
        </div>
        <div class="actions" th:if="${mortgageStatus == 'REQUESTED' and buyer != null and currentUserEmail != null and currentUserEmail.equals(buyer.email)}">
            <button class="btn btn-outline" type="button" onclick="setMortgageStatus('APPROVED')">–û–¥–æ–±—Ä–∏—Ç—å –∏–ø–æ—Ç–µ–∫—É</button>
            <button class="btn btn-outline" type="button" onclick="setMortgageStatus('REJECTED')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∏–ø–æ—Ç–µ–∫—É</button>
        </div>
    </div>

    <div class="card section">
        <div class="title" style="font-weight:700;margin-bottom:8px;">–¢–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞</div>
        <div class="muted" style="margin-bottom:8px;">–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–∞—è —á–∞—Å—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –¥–∞–Ω–Ω—ã—Ö.</div>
        <div style="line-height:1.6;color:#0f172a;">
            <p>
                –ì—Ä–∞–∂–¥–∞–Ω–∏–Ω(–∫–∞)
                <strong th:text="${seller != null ? (seller.firstName + (seller.lastName != null ? ' ' + seller.lastName : '')) : '–ü—Ä–æ–¥–∞–≤–µ—Ü'}">–ü—Ä–æ–¥–∞–≤–µ—Ü</strong>,
                –∏–º–µ–Ω—É–µ–º—ã–π(–∞—è) –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ü—Ä–æ–¥–∞–≤–µ—Ü¬ª, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω(–∫–∞)
                <strong th:text="${buyer != null ? (buyer.firstName + (buyer.lastName != null ? ' ' + buyer.lastName : '')) : '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å'}">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</strong>,
                –∏–º–µ–Ω—É–µ–º—ã–π(–∞—è) –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ü–æ–∫—É–ø–∞—Ç–µ–ª—å¬ª, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∞ –≤–º–µ—Å—Ç–µ –∏–º–µ–Ω—É–µ–º—ã–µ ¬´–°—Ç–æ—Ä–æ–Ω—ã¬ª, –∑–∞–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–æ–≥–æ–≤–æ—Ä –æ –Ω–∏–∂–µ—Å–ª–µ–¥—É—é—â–µ–º.
            </p>
            <h3 style="margin:14px 0 6px;">1. –ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞</h3>
            <p>
                1.1. –ü—Ä–æ–¥–∞–≤–µ—Ü –ø—Ä–æ–¥–∞–µ—Ç, –∞ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –ø—Ä–∏–æ–±—Ä–µ—Ç–∞–µ—Ç –æ–±—ä–µ–∫—Ç –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏: 
                <strong th:text="${property != null ? (property.type != null ? property.type : '–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å') : '–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å'}">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</strong>,
                —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω—ã–π –ø–æ –∞–¥—Ä–µ—Å—É: <strong th:text="${property != null ? property.address : '‚Äî'}">–ê–¥—Ä–µ—Å</strong>,
                –≥–æ—Ä–æ–¥ <strong th:text="${property != null ? (property.city != null ? property.city : '‚Äî') : '‚Äî'}">–ì–æ—Ä–æ–¥</strong>.
            </p>
            <p>
                1.2. –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –æ–±—ä–µ–∫—Ç–∞: –æ–±—â–∞—è –ø–ª–æ—â–∞–¥—å ‚Äî
                <strong th:text="${property != null && property.area != null ? property.area + ' –º¬≤' : '‚Äî'}">‚Äî</strong>,
                –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç ‚Äî <strong th:text="${property != null && property.rooms != null ? property.rooms : '‚Äî'}">‚Äî</strong>,
                —ç—Ç–∞–∂ / —ç—Ç–∞–∂–Ω–æ—Å—Ç—å ‚Äî <strong th:text="${property != null ? ((property.floor != null ? property.floor : '‚Äî') + ' / ' + (property.floorsTotal != null ? property.floorsTotal : '‚Äî')) : '‚Äî'}">‚Äî</strong>.
            </p>
            <h3 style="margin:14px 0 6px;">2. –¶–µ–Ω–∞ –∏ –ø–æ—Ä—è–¥–æ–∫ —Ä–∞—Å—á–µ—Ç–æ–≤</h3>
            <p>
                2.1. –¶–µ–Ω–∞ –æ–±—ä–µ–∫—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç
                <strong th:text="${deal != null && deal.finalPrice != null ? #numbers.formatDecimal(deal.finalPrice, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ' : (property != null && property.price != null ? #numbers.formatDecimal(property.price, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ' : '‚Äî')}">‚Äî</strong>.
            </p>
            <h3 style="margin:14px 0 6px;">3. –ü—Ä–æ—á–∏–µ —É—Å–ª–æ–≤–∏—è</h3>
            <p>
                3.1. –ù–∞—Å—Ç–æ—è—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è —à–∞–±–ª–æ–Ω–æ–º –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –Ω–æ—Ç–∞—Ä–∏–∞–ª—å–Ω–æ –∑–∞–≤–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä, –µ—Å–ª–∏ —Ç–∞–∫–æ–≤–æ–π —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º.
            </p>
        </div>
    </div>

    <div class="card section">
        <div class="muted">–ù–∞–∂–∏–º–∞—è ¬´–ü—Ä–∏–Ω—è—Ç—å¬ª, –ø–æ–∫—É–ø–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –ø—Ä–∏–º–µ—Ä–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –≤—ã—Ä–∞–∂–∞–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–¥–µ–ª–∫—É –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É. –î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è —à–∞–±–ª–æ–Ω–æ–º –¥–ª—è –æ–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏—è –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –Ω–æ—Ç–∞—Ä–∏–∞–ª—å–Ω–æ –∑–∞–≤–µ—Ä–µ–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä, –µ—Å–ª–∏ —Ç–∞–∫–æ–≤–æ–π —Ç—Ä–µ–±—É–µ—Ç—Å—è.</div>
        <div class="actions">
            <a class="btn btn-outline" href="/deals">‚Üê –ù–∞–∑–∞–¥ –∫ –ú–æ–∏ —Å–¥–µ–ª–∫–∏</a>
        </div>
        <!-- –ö–Ω–æ–ø–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å pending -->
        <div class="actions" th:if="${!readonly and deal != null and deal.status.name() == 'pending' and buyer != null and currentUserEmail != null and currentUserEmail.equals(buyer.email)}">
            <button class="btn btn-primary" th:onclick="|acceptDeal(${deal.id})|">–ü—Ä–∏–Ω—è—Ç—å</button>
            <button class="btn btn-secondary" th:onclick="|declineDeal(${deal.id})|">–û—Ç–∫–∞–∑–∞—Ç—å—Å—è</button>
            <a class="btn btn-outline" th:if="${canGeneratePdf}" th:href="@{|/deal/${deal.id}/pdf|}">–°–∫–∞—á–∞—Ç—å PDF</a>
            <span class="muted" th:if="${!canGeneratePdf}">PDF –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É —Å—Ç–æ—Ä–æ–Ω –∏ (–¥–ª—è —á–∞—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ–¥–∞–≤—Ü–∞) –æ–¥–æ–±—Ä–µ–Ω–∏–µ –±–∞–Ω–∫–∞</span>
        </div>
        <div class="actions" th:if="${readonly or deal == null or deal.status.name() != 'pending' or buyer == null or currentUserEmail == null or !currentUserEmail.equals(buyer.email)}">
            <a class="btn btn-outline" th:if="${canGeneratePdf}" th:href="@{|/deal/${deal.id}/pdf|}">–°–∫–∞—á–∞—Ç—å PDF</a>
            <span class="muted" th:if="${!canGeneratePdf}">PDF –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É —Å—Ç–æ—Ä–æ–Ω –∏ (–¥–ª—è —á–∞—Å—Ç–Ω–æ–≥–æ –ø—Ä–æ–¥–∞–≤—Ü–∞) –æ–¥–æ–±—Ä–µ–Ω–∏–µ –±–∞–Ω–∫–∞</span>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const DEAL_ID = /*[[${deal.id}]]*/ 0;

    async function acceptDeal(id) {
        try {
            const res = await fetch(`/v1/api/deal/${id}/accept`, { method: 'POST' });
            if (!res.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –¥–æ–≥–æ–≤–æ—Ä'); return; }
            const data = await res.json();
            window.location.href = data.redirect || '/deals';
        } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }

    async function declineDeal(id) {
        try {
            const res = await fetch(`/v1/api/deal/${id}/decline`, { method: 'POST' });
            if (!res.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä'); return; }
            const data = await res.json();
            window.location.href = data.redirect || '/deals';
        } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }

    async function requestBankApproval() {
        try {
            const bankName = prompt('–£–∫–∞–∂–∏—Ç–µ –±–∞–Ω–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–±–µ—Ä–±–∞–Ω–∫):', '–ë–∞–Ω–∫');
            const res = await fetch('/v1/api/bank-approval/request', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dealId: String(DEAL_ID), bankName: bankName || '–ë–∞–Ω–∫' })
            });
            if (!res.ok) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –±–∞–Ω–∫'); return; }
            location.reload();
        } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }

    async function refreshBankApproval() { location.reload(); }

    async function setBankApprovalStatus(status) {
        try {
            const res = await fetch(`/v1/api/bank-approval/${DEAL_ID}/set-status`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok || !data.success) { alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å'); return; }
            location.reload();
        } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }

    async function applyMortgage() {
        try {
            const bankName = prompt('–£–∫–∞–∂–∏—Ç–µ –±–∞–Ω–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°–±–µ—Ä–±–∞–Ω–∫):', '–ë–∞–Ω–∫');
            if (bankName === null) return;
            const amount = prompt('–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ (–±–µ–∑ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –≤–∑–Ω–æ—Å–∞), ‚ÇΩ:', '3000000');
            if (amount === null) return;
            const downPayment = prompt('–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å, ‚ÇΩ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):', '0');
            if (downPayment === null) return;
            const termMonths = prompt('–°—Ä–æ–∫, –º–µ—Å—è—Ü–µ–≤:', '240');
            if (termMonths === null) return;
            const rate = prompt('–°—Ç–∞–≤–∫–∞, % –≥–æ–¥–æ–≤—ã—Ö:', '12.0');
            if (rate === null) return;
            const res = await fetch('/v1/api/mortgage/apply', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dealId: String(DEAL_ID), bankName, amount, downPayment, termMonths, rate })
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok || !data.success) { alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –∏–ø–æ—Ç–µ–∫—É'); return; }
            location.reload();
        } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }

    async function setMortgageStatus(status) {
        try {
            const res = await fetch(`/v1/api/mortgage/${DEAL_ID}/set-status`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok || !data.success) { alert(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–ø–æ—Ç–µ–∫–∏'); return; }
            location.reload();
        } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); }
    }
</script>
</body>
</html>
