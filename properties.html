<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è ‚Äî RealEstate</title>
    <style>
        body { margin:0; font-family: Arial, Helvetica, sans-serif; color:#0f172a; background:#ffffff; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; }
        .nav { display:flex; align-items:center; justify-content:space-between; padding:12px 0; border-bottom:1px solid #dbeafe; }
        .brand { display:flex; align-items:center; gap:10px; font-weight:700; color:#1e293b; }
        .brand .logo { width:30px; height:30px; display:grid; place-items:center; border-radius:6px; background:#2563eb; color:#fff; font-size:16px; }
        .nav-links { display:flex; align-items:center; gap:10px; }
        .nav-links a { text-decoration:none; color:#1f2937; padding:6px 10px; border-radius:6px; }
        .nav-links a:hover { background:#eff6ff; }
        .btn { display:inline-block; padding:8px 12px; border-radius:6px; text-decoration:none; font-weight:600; border:1px solid #dbeafe; background:#ffffff; color:#1e293b; }
        .btn-primary { background:#2563eb; color:#fff; border-color:#2563eb; }
        .btn-plain { border:1px solid #dbeafe; background:#fff; color:#1f2937; padding:8px 12px; }
        .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:14px; margin:20px 0; }
        .card { background:#fff; border:1px solid #e2e8f0; border-radius:10px; overflow:hidden; transition: box-shadow .15s ease, transform .15s ease; max-width: 400px; width: 100%; position:relative; }
        .card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.06); transform: translateY(-2px); }
        .media { position:relative; width:100%; aspect-ratio: 16 / 9; background:#e2e8f0; overflow:hidden; }
        .media img { width:100%; height:100%; object-fit:cover; display:block; transition: transform .25s ease; }
        .card:hover .media img { transform: scale(1.03); }
        .meta { position:absolute; inset:auto 0 0 0; padding:10px 12px; background: linear-gradient(to top, rgba(15,23,42,.70), rgba(15,23,42,.0)); color:#fff; display:grid; gap:4px; }
        .meta .loc { font-size:12px; opacity:.9; display:flex; align-items:center; gap:6px; }
        .meta .loc .dot { width:6px; height:6px; border-radius:50%; background:#93c5fd; display:inline-block; }
        .meta .title { font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .meta .spec { font-size:12px; opacity:.95; }
        .meta .price { font-weight:800; font-size:15px; }
        .card-body { padding:10px 12px; display:grid; gap:6px; }
        .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#eff6ff; color:#1d4ed8; font-size:12px; }
        .pill.promoted { background:#fef3c7; color:#92400e; }
        .card-link { position:absolute; inset:0; z-index:1; }
        .admin-actions { display:flex; gap:4px; margin-top:6px; position:relative; z-index:2; flex-wrap:wrap; }
        .btn-xs { padding:4px 8px; border-radius:6px; border:1px solid #e2e8f0; background:#fff; color:#334155; font-size:11px; cursor:pointer; white-space:nowrap; flex-shrink:0; }
        .btn-xs.danger { border-color:#fecaca; color:#b91c1c; }
        .btn-xs.promoted-btn { border-color:#fbbf24; background:#fef3c7; color:#92400e; }
        .author-info { font-size:11px; color:#64748b; margin-top:4px; display:flex; align-items:center; gap:4px; }
        .author-info .author-name { font-weight:600; color:#334155; }
        .author-info .author-badge { padding:2px 6px; border-radius:4px; background:#dbeafe; color:#1e40af; font-size:10px; }
        .fab-add { position: fixed; right: 16px; bottom: 16px; padding: 10px 14px; border-radius: 999px; background: #2563eb; color:#fff; border:none; cursor:pointer; z-index:1000; }
        .modal { position: fixed; inset:0; background: rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:10000; }
        .modal.open { display:flex; }
        .modal-card { width: 720px; max-width: calc(100% - 24px); background:#fff; border-radius:8px; border:1px solid #e2e8f0; overflow:hidden; max-height: calc(100vh - 40px); display:flex; flex-direction:column; }
        .modal-head { padding:10px 12px; background:#eff6ff; font-weight:700; color:#334155; display:flex; justify-content:space-between; align-items:center; flex-shrink:0; }
        .modal-body { padding:12px; display:grid; gap:8px; grid-template-columns: repeat(2, 1fr); overflow-y:auto; flex:1; }
        .modal-body .full { grid-column: 1 / -1; }
        .modal-body label { display:block; font-size:12px; color:#64748b; margin-bottom:6px; }
        .modal-body input, .modal-body select, .modal-body textarea { width:100%; padding:10px 12px; border:1px solid #e2e8f0; border-radius:6px; box-sizing:border-box; }
        .modal-foot { padding:10px 12px; display:flex; gap:10px; justify-content:flex-end; background:#fafafa; border-top:1px solid #e2e8f0; }
        .btn-primary-sm { padding:8px 12px; border:none; border-radius:6px; background:#2563eb; color:#fff; cursor:pointer; }
        .btn-secondary-sm { padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; background:#fff; color:#334155; cursor:pointer; }
        .error-text { color:#b91c1c; font-size:12px; margin-top:4px; }
        .toasts { position: fixed; right: 16px; top: 16px; display:grid; gap:8px; z-index: 9999; }
        .toast { padding:10px 12px; border-radius:6px; background:#fff; border:1px solid #e2e8f0; color:#111827; }
        .toast.success { border-color:#bbf7d0; background:#f0fdf4; color:#14532d; }
        .toast.error { border-color:#fecaca; background:#fff1f2; color:#7f1d1d; }
        .page-title { margin:20px 0 10px; font-size:24px; font-weight:700; color:#0f172a; }
        .empty-state { text-align:center; padding:40px 20px; color:#64748b; }
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ */
        .property-view-modal { position: fixed; inset:0; background: rgba(15,23,42,.7); display:none; align-items:center; justify-content:center; z-index:10000; overflow-y:auto; padding:20px; }
        .property-view-modal.open { display:flex; }
        .property-view-card { width: 900px; max-width: calc(100% - 40px); background:#fff; border-radius:8px; border:1px solid #e2e8f0; overflow:hidden; position:relative; margin:auto; }
        .property-view-gallery { width:100%; background:#eff6ff; display:flex; gap:8px; overflow:auto; padding:8px; border-bottom:1px solid #dbeafe; }
        .property-view-gallery img { height:320px; border-radius:6px; object-fit:cover; flex-shrink:0; }
        .property-view-gallery.single { justify-content:center; }
        .property-view-gallery.single img { width:100%; height:auto; max-height:520px; }
        .property-view-content { padding:20px; }
        .property-view-title { font-size:24px; font-weight:700; margin:0 0 12px; color:#0f172a; }
        .property-view-price { font-size:20px; font-weight:700; color:#0f172a; margin:0 0 20px; }
        .property-view-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; margin:20px 0; }
        .property-view-row { background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:12px; }
        .property-view-label { color:#475569; font-size:13px; margin-bottom:4px; }
        .property-view-value { color:#0f172a; font-weight:600; font-size:14px; }
        .property-view-description { background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:12px; margin:20px 0; }
        .property-view-author { font-size:14px; color:#64748b; margin-top:16px; padding:12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; display:flex; align-items:center; gap:8px; }
        .property-view-author-name { font-weight:600; color:#334155; }
        .property-view-author-badge { padding:3px 8px; border-radius:4px; background:#dbeafe; color:#1e40af; font-size:11px; }
        .property-view-key-features { display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin:20px 0; }
        .property-view-key-feature { display:flex; align-items:center; gap:8px; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; }
        .property-view-key-feature-icon { font-size:20px; }
        .property-view-key-feature-text { display:flex; flex-direction:column; }
        .property-view-key-feature-label { font-size:11px; color:#64748b; }
        .property-view-key-feature-value { font-size:14px; font-weight:600; color:#0f172a; }
        .property-view-section { margin:24px 0; }
        .property-view-section-title { font-size:18px; font-weight:700; color:#0f172a; margin:0 0 16px; }
        .property-view-section-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
        .property-view-utilities { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin:16px 0; }
        .property-view-utility { display:flex; justify-content:space-between; padding:8px 12px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; }
        .property-view-utility-label { font-size:13px; color:#475569; }
        .property-view-utility-value { font-size:13px; font-weight:600; color:#0f172a; }
        .property-view-amenities { display:flex; flex-wrap:wrap; gap:6px; margin:12px 0; }
        .property-view-amenity { padding:6px 12px; background:#eff6ff; color:#1e40af; border-radius:999px; font-size:12px; }
        .property-view-actions { display:flex; gap:8px; margin-top:20px; flex-wrap:wrap; }
        .property-view-close { position:absolute; top:12px; right:12px; width:32px; height:32px; border-radius:50%; background:#fff; border:1px solid #e2e8f0; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; color:#64748b; z-index:10; }
        .property-view-close:hover { background:#f8fafc; }
        .property-view-chat-btn { padding:10px 20px; border-radius:6px; background:#2563eb; color:#fff; border:none; cursor:pointer; font-size:14px; margin-top:12px; }
        .property-view-chat-btn:hover { background:#1e40af; }
        @media (max-width: 980px) { .property-view-grid { grid-template-columns: 1fr; } .property-view-section-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <!-- Hidden element for current user email -->
    <span id="current-user-email" th:if="${currentUserEmail != null}" th:text="${currentUserEmail}" style="display:none;"></span>
    <header class="container nav">
        <div class="brand">
            <div class="logo">üè†</div>
            <div>RealEstate</div>
        </div>
        <div class="nav-links">
            <a th:href="@{/}" class="btn">–ì–ª–∞–≤–Ω–∞—è</a>
            <a th:href="@{/properties}" class="btn">–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</a>
            <a th:href="@{/user/properties}" class="btn btn-primary">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</a>
            <a th:href="@{/user/favorites}" class="btn" sec:authorize="!hasRole('ROLE_ADMIN')">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ ‚ù§Ô∏è</a>
            <a th:href="@{/chats}" class="btn" sec:authorize="isAuthenticated()">–ß–∞—Ç—ã üí¨</a>
            <a th:href="@{/realtor/stats}" class="btn" sec:authorize="hasRole('REALTOR')">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ üìä</a>
            <a th:href="@{/reports}" class="btn" sec:authorize="isAuthenticated()">–û—Ç—á–µ—Ç—ã</a>
            <a th:href="@{/user/profile}" class="btn">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a th:href="@{/logout}" class="btn">–í—ã–π—Ç–∏</a>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h1>
        <div style="display:flex; gap:8px; margin-bottom:8px;">
            <a th:href="@{/user/properties}" class="btn" th:classappend="${tabArchived} ? '' : ' btn-primary'">–ê–∫—Ç–∏–≤–Ω—ã–µ</a>
            <a th:href="@{/user/properties(status='archived')}" class="btn" th:classappend="${tabArchived} ? ' btn-primary' : ''">–ê—Ä—Ö–∏–≤</a>
        </div>
        
        <div th:if="${items == null or items.isEmpty()}" class="empty-state">
            <p style="font-size:48px; margin:0 0 16px;">üìù</p>
            <p style="margin:0 0 10px; font-size:18px; font-weight:600; color:#0f172a;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏–π</p>
            <p style="margin:0 0 20px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–¥–∞–∂–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏</p>
            <button class="btn btn-primary" onclick="openPropertyModal(null)">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>
        </div>

        <div class="grid">
            <div class="card" th:each="p : ${items}">
                <div class="card-link" th:onclick="|openPropertyView(${p.id}); return false;|" style="cursor:pointer;"></div>
                <div class="media">
                    <img alt="card" th:src="${p.firstImageUrl != null ? p.firstImageUrl : 'https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop'}"/>
                    <div class="meta">
                        <div class="loc"><span class="dot"></span><span th:text="${(p.city != null ? p.city : '‚Äî') + (p.district != null ? ', ' + p.district : '')}">–ì–æ—Ä–æ–¥, —Ä–∞–π–æ–Ω</span></div>
                        <div class="title" th:text="${p.titleForCard}">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                        <div class="spec" th:text="|${p.rooms} –∫–æ–º–Ω ¬∑ ${p.area} –º¬≤ ¬∑ ${p.floor != null ? p.floor : '-'} / ${p.floorsTotal != null ? p.floorsTotal : '-'}|">—Å–ø–µ–∫–∏</div>
                        <div class="price" th:text="${#numbers.formatDecimal(p.price, 0, 'COMMA', 0, 'POINT') + ' ‚ÇΩ'}">–¶–µ–Ω–∞</div>
                    </div>
                </div>
                <div class="card-body">
                    <div style="display:flex; gap:6px; flex-wrap:wrap;">
                        <span class="pill" th:text="${p.category}">–∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                        <span class="pill promoted" th:if="${p.promoted}">–õ—É—á—à–µ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</span>
                    </div>
                    <div class="author-info" th:if="${p.user != null}">
                        <span>–ê–≤—Ç–æ—Ä:</span>
                        <span class="author-name" th:text="${p.user.firstName != null ? p.user.firstName + ' ' + (p.user.lastName != null ? p.user.lastName : '') : p.user.email}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                        <span class="author-badge" th:if="${p.realtor != null}">–†–∏–µ–ª—Ç–æ—Ä</span>
                    </div>
                    <div class="admin-actions" sec:authorize="isAuthenticated()"
                         th:attr="data-id=${p.id}, data-type=${p.type}, data-category=${p.category}, data-address=${p.address}, data-city=${p.city}, data-district=${p.district}, data-area=${p.area}, data-rooms=${p.rooms}, data-floor=${p.floor}, data-floors=${p.floorsTotal}, data-price=${p.price}, data-imageUrls=${p.imageUrls}, data-description=${p.description}, data-promoted=${p.promoted}, data-status=${p.status}">
                        <button class="btn-xs" onclick="openPropertyModal(this); event.stopPropagation(); return false;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-xs danger" onclick="deleteProperty(this); event.stopPropagation(); return false;">–£–¥–∞–ª–∏—Ç—å</button>
                        <button class="btn-xs" th:classappend="${p.promoted} ? 'promoted-btn' : ''" th:onclick="|togglePromote(${p.id}, this); event.stopPropagation(); return false;|" th:text="${p.promoted} ? '–°–Ω—è—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ' : '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å'" sec:authorize="isAuthenticated()">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å</button>
                        <button class="btn-xs" th:attr="data-status=${p.status}" onclick="toggleArchive(this); event.stopPropagation(); return false;" th:text="${p.status != null and p.status.toString() == 'archived' ? '–í–µ—Ä–Ω—É—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞' : '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}"></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button class="fab-add" sec:authorize="isAuthenticated()" onclick="openPropertyModal(null)">+ –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</button>

    <div id="prop-modal" class="modal" sec:authorize="isAuthenticated()">
        <div class="modal-card">
            <div class="modal-head">
                <span id="prop-modal-title">–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</span>
                <button class="btn-secondary-sm" onclick="closePropertyModal()" style="padding:4px 8px; font-size:12px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="f-id" />
                <div>
                    <label>–¢–∏–ø</label>
                    <select id="f-type">
                        <option value="–∫–≤–∞—Ä—Ç–∏—Ä–∞">–ö–≤–∞—Ä—Ç–∏—Ä–∞</option>
                        <option value="–¥–æ–º">–î–æ–º</option>
                        <option value="–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è</option>
                    </select>
                    <div id="e-type" class="error-text" style="display:none"></div>
                </div>
                <div>
                    <label>–†—ã–Ω–æ–∫</label>
                    <select id="f-category">
                        <option value="–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞">–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∞</option>
                        <option value="–í—Ç–æ—Ä–∏—á–∫–∞">–í—Ç–æ—Ä–∏—á–∫–∞</option>
                    </select>
                    <div id="e-category" class="error-text" style="display:none"></div>
                </div>
                <div class="full">
                    <label>–ê–¥—Ä–µ—Å</label>
                    <input id="f-address" />
                    <div id="e-address" class="error-text" style="display:none"></div>
                </div>
                <div>
                    <label>–ì–æ—Ä–æ–¥</label>
                    <input id="f-city" />
                    <div id="e-city" class="error-text" style="display:none"></div>
                </div>
                <div>
                    <label>–†–∞–π–æ–Ω</label>
                    <input id="f-district" />
                    <div id="e-district" class="error-text" style="display:none"></div>
                </div>
                <div>
                    <label>–ü–ª–æ—â–∞–¥—å (–º¬≤)</label>
                    <input id="f-area" type="number" step="0.1" />
                    <div id="e-area" class="error-text" style="display:none"></div>
                </div>
                <div>
                    <label>–ö–æ–º–Ω–∞—Ç</label>
                    <input id="f-rooms" type="number" />
                    <div id="e-rooms" class="error-text" style="display:none"></div>
                </div>
                <div id="f-floor-group">
                    <label>–≠—Ç–∞–∂</label>
                    <input id="f-floor" type="number" />
                    <div id="e-floor" class="error-text" style="display:none"></div>
                </div>
                <div>
                    <label>–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</label>
                    <input id="f-floors" type="number" />
                    <div id="e-floors" class="error-text" style="display:none"></div>
                </div>
                <div>
                    <label>–¶–µ–Ω–∞</label>
                    <input id="f-price" type="number" step="0.01" />
                    <div id="e-price" class="error-text" style="display:none"></div>
                </div>
                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
                <div id="f-kitchen-area-group" style="display:none;">
                    <label>–ü–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏ (–º¬≤)</label>
                    <input id="f-kitchen-area" type="number" step="0.1" />
                </div>
                <div>
                    <label>–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</label>
                    <input id="f-year-built" type="number" min="1800" max="2100" />
                </div>
                <div id="f-building-material-group">
                    <label>–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–º–∞</label>
                    <select id="f-building-material">
                        <option value="">‚Äî</option>
                        <option value="–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π">–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π</option>
                        <option value="–ö–∏—Ä–ø–∏—á–Ω—ã–π">–ö–∏—Ä–ø–∏—á–Ω—ã–π</option>
                        <option value="–ü–∞–Ω–µ–ª—å–Ω—ã–π">–ü–∞–Ω–µ–ª—å–Ω—ã–π</option>
                        <option value="–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π">–ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π</option>
                        <option value="–ë–ª–æ—á–Ω—ã–π">–ë–ª–æ—á–Ω—ã–π</option>
                    </select>
                </div>
                <div>
                    <label>–°–æ—Å—Ç–æ—è–Ω–∏–µ</label>
                    <select id="f-condition">
                        <option value="">‚Äî</option>
                        <option value="–ú–æ–∂–Ω–æ –∂–∏—Ç—å">–ú–æ–∂–Ω–æ –∂–∏—Ç—å</option>
                        <option value="–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞">–¢—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞</option>
                        <option value="–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞">–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞</option>
                    </select>
                </div>
                <div id="f-plot-area-group" style="display:none;">
                    <label>–ü–ª–æ—â–∞–¥—å —É—á–∞—Å—Ç–∫–∞ (—Å–æ—Ç.)</label>
                    <input id="f-plot-area" type="number" step="0.1" />
                </div>
                <div id="f-land-category-group" style="display:none;">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å</label>
                    <input id="f-land-category" />
                </div>
                <div id="f-property-class-group" style="display:none;">
                    <label>–ö–ª–∞—Å—Å</label>
                    <select id="f-property-class">
                        <option value="">‚Äî</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>
                <div>
                    <label>–ü–∞—Ä–∫–æ–≤–∫–∞</label>
                    <input id="f-parking" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 400 –º–µ—Å—Ç, –ù–∞–∑–µ–º–Ω–∞—è" />
                </div>
                <div id="f-bedrooms-group" style="display:none;">
                    <label>–°–ø–∞–ª–µ–Ω</label>
                    <input id="f-bedrooms" type="number" />
                </div>
                <div>
                    <label>–°–∞–Ω—É–∑–µ–ª</label>
                    <input id="f-bathrooms" type="number" />
                </div>
                <div id="f-window-view-group" style="display:none;">
                    <label>–í–∏–¥ –∏–∑ –æ–∫–æ–Ω</label>
                    <select id="f-window-view">
                        <option value="">‚Äî</option>
                        <option value="–ù–∞ —É–ª–∏—Ü—É">–ù–∞ —É–ª–∏—Ü—É</option>
                        <option value="–í–æ –¥–≤–æ—Ä">–í–æ –¥–≤–æ—Ä</option>
                        <option value="–ù–∞ –≥–æ—Ä–æ–¥">–ù–∞ –≥–æ—Ä–æ–¥</option>
                    </select>
                </div>
                <div>
                    <label>–ü—Ä–æ–¥–∞—ë—Ç—Å—è —Å –º–µ–±–µ–ª—å—é</label>
                    <select id="f-furnished">
                        <option value="">‚Äî</option>
                        <option value="true">–î–∞</option>
                        <option value="false">–ù–µ—Ç</option>
                    </select>
                </div>
                <div>
                    <label>–†–µ–º–æ–Ω—Ç</label>
                    <select id="f-renovation">
                        <option value="">‚Äî</option>
                        <option value="–î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π">–î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π</option>
                        <option value="–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π">–ö–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∏–π</option>
                        <option value="–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞">–ë–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞</option>
                    </select>
                </div>
                <div>
                    <label>–û—Ç–æ–ø–ª–µ–Ω–∏–µ</label>
                    <select id="f-heating">
                        <option value="">‚Äî</option>
                        <option value="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ</option>
                        <option value="–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ">–ê–≤—Ç–æ–Ω–æ–º–Ω–æ–µ</option>
                        <option value="–ì–∞–∑–æ–≤–æ–µ">–ì–∞–∑–æ–≤–æ–µ</option>
                    </select>
                </div>
                <div>
                    <label>–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ</label>
                    <select id="f-water-supply">
                        <option value="">‚Äî</option>
                        <option value="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ</option>
                        <option value="–°–∫–≤–∞–∂–∏–Ω–∞">–°–∫–≤–∞–∂–∏–Ω–∞</option>
                    </select>
                </div>
                <div>
                    <label>–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è</label>
                    <select id="f-sewerage">
                        <option value="">‚Äî</option>
                        <option value="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è</option>
                        <option value="–°–µ–ø—Ç–∏–∫">–°–µ–ø—Ç–∏–∫</option>
                    </select>
                </div>
                <div>
                    <label>–ì–∞–∑</label>
                    <select id="f-gas">
                        <option value="">‚Äî</option>
                        <option value="–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π">–ú–∞–≥–∏—Å—Ç—Ä–∞–ª—å–Ω—ã–π</option>
                        <option value="–ë–∞–ª–ª–æ–Ω–Ω—ã–π">–ë–∞–ª–ª–æ–Ω–Ω—ã–π</option>
                        <option value="–ù–µ—Ç">–ù–µ—Ç</option>
                    </select>
                </div>
                <div>
                    <label>–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ</label>
                    <select id="f-electricity">
                        <option value="">‚Äî</option>
                        <option value="–ï—Å—Ç—å">–ï—Å—Ç—å</option>
                        <option value="–ù–µ—Ç">–ù–µ—Ç</option>
                    </select>
                </div>
                <div class="full">
                    <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–¥–æ–±—Å—Ç–≤–∞ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input id="f-amenities" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–µ—Ä—Ä–∞—Å–∞, –ì–∞—Ä–∞–∂, –ë–∞–Ω—è, –û—Ö—Ä–∞–Ω–∞" />
                </div>
                <div class="full">
                    <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</label>
                    <input id="f-files" type="file" accept="image/*" multiple />
                    <div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
                        <button type="button" class="btn-secondary-sm" onclick="uploadImages()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
                        <span id="upload-status" style="font-size:12px; color:#64748b;"></span>
                    </div>
                </div>
                <div class="full">
                    <label>–§–æ—Ç–æ (URL —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏)</label>
                    <input id="f-images" placeholder="https://...jpg, https://...jpg" />
                </div>
                <div class="full">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="f-description" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn-secondary-sm" onclick="closePropertyModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-primary-sm" onclick="saveProperty()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="toasts" class="toasts" sec:authorize="isAuthenticated()"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ -->
    <div id="property-view-modal" class="property-view-modal">
        <div class="property-view-card">
            <button class="property-view-close" onclick="closePropertyView()">√ó</button>
            <div class="property-view-gallery">
                <!-- –ì–∞–ª–µ—Ä–µ—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </div>
            <div class="property-view-content">
                <div class="property-view-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="property-view-price">‚Äî</div>
                <div class="property-view-key-features">
                    <!-- –ö–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="property-view-content-details">
                    <!-- –î–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="property-view-description">
                    <div class="property-view-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                    <div class="property-view-value property-view-description-text">‚Äî</div>
                </div>
                <div class="property-view-author property-view-author-info">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <button class="property-view-chat-btn" style="display:none;">–°–≤—è–∑–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <script>
        function showToast(message, type){
            const c = document.getElementById('toasts');
            if (!c) return;
            const d = document.createElement('div');
            d.className = `toast ${type||''}`;
            d.textContent = message;
            c.appendChild(d);
            setTimeout(()=>{ d.remove(); }, 3000);
        }
        function qs(id){return document.getElementById(id);}        
        async function toggleArchive(btn) {
            try {
                if (!btn) return;
                const container = btn.closest('.admin-actions');
                const id = container ? container.getAttribute('data-id') : null;
                const status = btn.getAttribute('data-status');
                if (!id) { showToast('ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error'); return; }
                const archived = (status === 'archived');
                const url = archived ? `/v1/api/properties/${id}/unarchive` : `/v1/api/properties/${id}/archive`;
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    cache: 'no-store'
                });
                if (!res.ok) { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å', 'error'); return; }
                const saved = await res.json().catch(()=>({}));
                if (saved && saved.status) {
                    btn.textContent = (saved.status === 'archived') ? '–í–µ—Ä–Ω—É—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞' : '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
                    btn.setAttribute('data-status', saved.status);
                }
                showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                setTimeout(()=>{ location.reload(); }, 200);
            } catch(e) {
                // –§–æ–ª–±—ç–∫: –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å POST —á–µ—Ä–µ–∑ —Å–∫—Ä—ã—Ç—É—é —Ñ–æ—Ä–º—É
                try {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = (btn.getAttribute('data-status') === 'archived')
                        ? `/v1/api/properties/${btn.closest('.admin-actions').getAttribute('data-id')}/unarchive`
                        : `/v1/api/properties/${btn.closest('.admin-actions').getAttribute('data-id')}/archive`;
                    form.style.display = 'none';
                    document.body.appendChild(form);
                    form.submit();
                } catch(_) {
                    showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
                }
            }
        }
        
        async function openPropertyView(propertyId) {
            try {
                const res = await fetch('/v1/api/properties/' + propertyId);
                if (!res.ok) {
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
                    return;
                }
                const property = await res.json();
                
                const modal = document.getElementById('property-view-modal');
                if (!modal) {
                    showToast('–û—à–∏–±–∫–∞: –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                    return;
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏
                const titleEl = modal.querySelector('.property-view-title');
                const priceEl = modal.querySelector('.property-view-price');
                const galleryEl = modal.querySelector('.property-view-gallery');
                const keyFeaturesEl = modal.querySelector('.property-view-key-features');
                const contentEl = modal.querySelector('.property-view-content-details');
                const descriptionEl = modal.querySelector('.property-view-description-text');
                const authorEl = modal.querySelector('.property-view-author-info');
                const chatBtnEl = modal.querySelector('.property-view-chat-btn');
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ü–µ–Ω—É
                const propertyType = property.type || '';
                const propertyTitle = propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' 
                    ? `–ö–≤–∞—Ä—Ç–∏—Ä–∞ ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : propertyType === '–¥–æ–º'
                    ? `–î–æ–º ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è'
                    ? `–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ ${property.area ? property.area + ' –º¬≤' : ''} ${property.city || ''}`
                    : property.address || '–û–±—ä—è–≤–ª–µ–Ω–∏–µ';
                
                if (titleEl) titleEl.textContent = propertyTitle;
                if (priceEl) priceEl.textContent = property.price ? new Intl.NumberFormat('ru-RU').format(property.price) + ' ‚ÇΩ' : '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
                
                // –ì–∞–ª–µ—Ä–µ—è
                if (galleryEl) {
                    const imageUrls = property.imageUrls ? property.imageUrls.split(',').map(url => url.trim()).filter(url => url) : [];
                    if (imageUrls.length === 0) {
                        galleryEl.innerHTML = '<img src="https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop" alt="placeholder" />';
                        galleryEl.classList.add('single');
                    } else {
                        galleryEl.innerHTML = imageUrls.map(url => `<img src="${url}" alt="photo" onerror="this.src='https://images.unsplash.com/photo-1505693416388-ac5ce068fe85?q=80&w=1200&auto=format&fit=crop'" />`).join('');
                        galleryEl.classList.toggle('single', imageUrls.length === 1);
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                if (keyFeaturesEl) {
                    const features = [];
                    if (property.area) features.push({icon: 'üìê', label: '–û–±—â–∞—è –ø–ª–æ—â–∞–¥—å', value: property.area + ' –º¬≤'});
                    if (propertyType === '–¥–æ–º' && property.plotArea) features.push({icon: 'üèûÔ∏è', label: '–£—á–∞—Å—Ç–æ–∫', value: property.plotArea + ' —Å–æ—Ç.'});
                    if (propertyType === '–¥–æ–º' && property.buildingMaterial) features.push({icon: 'üèóÔ∏è', label: '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–º–∞', value: property.buildingMaterial});
                    if (propertyType === '–¥–æ–º' && property.floorsTotal) features.push({icon: 'ü™ú', label: '–≠—Ç–∞–∂–µ–π –≤ –¥–æ–º–µ', value: property.floorsTotal});
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.floor && property.floorsTotal) features.push({icon: 'ü™ú', label: '–≠—Ç–∞–∂', value: property.floor + ' –∏–∑ ' + property.floorsTotal});
                    if (propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' && property.floor && property.floorsTotal) features.push({icon: 'ü™ú', label: '–≠—Ç–∞–∂', value: property.floor + ' –∏–∑ ' + property.floorsTotal});
                    if (property.yearBuilt) features.push({icon: 'üìÖ', label: '–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏', value: property.yearBuilt});
                    if (propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è' && property.propertyClass) features.push({icon: '‚≠ê', label: '–ö–ª–∞—Å—Å', value: property.propertyClass});
                    if (property.parking) features.push({icon: 'üÖøÔ∏è', label: '–ü–∞—Ä–∫–æ–≤–∫–∞', value: property.parking});
                    
                    if (features.length > 0) {
                        keyFeaturesEl.innerHTML = features.map(f => `
                            <div class="property-view-key-feature">
                                <div class="property-view-key-feature-icon">${f.icon}</div>
                                <div class="property-view-key-feature-text">
                                    <div class="property-view-key-feature-label">${f.label}</div>
                                    <div class="property-view-key-feature-value">${f.value}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        keyFeaturesEl.innerHTML = '';
                    }
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
                if (contentEl) {
                    let html = '';
                    
                    // –°–µ–∫—Ü–∏—è "–û –∫–≤–∞—Ä—Ç–∏—Ä–µ" / "–û –¥–æ–º–µ" / "–û–± –æ–±—ä–µ–∫—Ç–µ"
                    const sectionTitle = propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' ? '–û –∫–≤–∞—Ä—Ç–∏—Ä–µ' 
                        : propertyType === '–¥–æ–º' ? '–û –¥–æ–º–µ' 
                        : '–û–± –æ–±—ä–µ–∫—Ç–µ';
                    
                    html += `<div class="property-view-section">
                        <div class="property-view-section-title">${sectionTitle}</div>
                        <div class="property-view-section-grid">`;
                    
                    if (property.area) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å</div><div class="property-view-value">${property.area} –º¬≤</div></div>`;
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.kitchenArea) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å –∫—É—Ö–Ω–∏</div><div class="property-view-value">${property.kitchenArea} –º¬≤</div></div>`;
                    if (property.rooms) html += `<div class="property-view-row"><div class="property-view-label">–ö–æ–º–Ω–∞—Ç</div><div class="property-view-value">${property.rooms}</div></div>`;
                    if (propertyType === '–¥–æ–º' && property.bedrooms) html += `<div class="property-view-row"><div class="property-view-label">–°–ø–∞–ª–µ–Ω</div><div class="property-view-value">${property.bedrooms}</div></div>`;
                    if (property.bathrooms) html += `<div class="property-view-row"><div class="property-view-label">–°–∞–Ω—É–∑–µ–ª</div><div class="property-view-value">${property.bathrooms} ${property.bathrooms === 1 ? '—Ä–∞–∑–¥–µ–ª—å–Ω—ã–π' : '—Ä–∞–∑–¥–µ–ª—å–Ω—ã—Ö'}</div></div>`;
                    if ((propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' || propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è') && property.floor !== null && property.floor !== undefined) {
                        if (property.floorsTotal) {
                            html += `<div class="property-view-row"><div class="property-view-label">–≠—Ç–∞–∂</div><div class="property-view-value">${property.floor} –∏–∑ ${property.floorsTotal}</div></div>`;
                        } else {
                            html += `<div class="property-view-row"><div class="property-view-label">–≠—Ç–∞–∂</div><div class="property-view-value">${property.floor}</div></div>`;
                        }
                    }
                    if (property.buildingMaterial) html += `<div class="property-view-row"><div class="property-view-label">–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–æ–º–∞</div><div class="property-view-value">${property.buildingMaterial}</div></div>`;
                    if (property.condition) html += `<div class="property-view-row"><div class="property-view-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ</div><div class="property-view-value">${property.condition}</div></div>`;
                    if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' && property.windowView) html += `<div class="property-view-row"><div class="property-view-label">–í–∏–¥ –∏–∑ –æ–∫–æ–Ω</div><div class="property-view-value">${property.windowView}</div></div>`;
                    if (property.renovation) html += `<div class="property-view-row"><div class="property-view-label">–†–µ–º–æ–Ω—Ç</div><div class="property-view-value">${property.renovation}</div></div>`;
                    if (property.furnished !== null && property.furnished !== undefined) html += `<div class="property-view-row"><div class="property-view-label">–ü—Ä–æ–¥–∞—ë—Ç—Å—è —Å –º–µ–±–µ–ª—å—é</div><div class="property-view-value">${property.furnished ? '–î–∞' : '–ù–µ—Ç'}</div></div>`;
                    if (property.category) html += `<div class="property-view-row"><div class="property-view-label">–¢–∏–ø –∂–∏–ª—å—è</div><div class="property-view-value">${property.category}</div></div>`;
                    
                    html += `</div></div>`;
                    
                    // –°–µ–∫—Ü–∏—è "–û–± —É—á–∞—Å—Ç–∫–µ" (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–º–æ–≤)
                    if (propertyType === '–¥–æ–º' && (property.plotArea || property.landCategory)) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–û–± —É—á–∞—Å—Ç–∫–µ</div>
                            <div class="property-view-section-grid">`;
                        if (property.plotArea) html += `<div class="property-view-row"><div class="property-view-label">–ü–ª–æ—â–∞–¥—å</div><div class="property-view-value">${property.plotArea} —Å–æ—Ç.</div></div>`;
                        if (property.landCategory) html += `<div class="property-view-row"><div class="property-view-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∑–µ–º–µ–ª—å</div><div class="property-view-value">${property.landCategory}</div></div>`;
                        html += `</div></div>`;
                    }
                    
                    // –°–µ–∫—Ü–∏—è "–û –¥–æ–º–µ" (–¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏)
                    if ((propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞' || propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è') && (property.yearBuilt || property.buildingMaterial || property.floorsTotal || property.parking)) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–û –¥–æ–º–µ</div>
                            <div class="property-view-section-grid">`;
                        if (property.yearBuilt) html += `<div class="property-view-row"><div class="property-view-label">–ì–æ–¥ –ø–æ—Å—Ç—Ä–æ–π–∫–∏</div><div class="property-view-value">${property.yearBuilt}</div></div>`;
                        if (property.buildingMaterial) html += `<div class="property-view-row"><div class="property-view-label">–¢–∏–ø –¥–æ–º–∞</div><div class="property-view-value">${property.buildingMaterial}</div></div>`;
                        if (property.floorsTotal) html += `<div class="property-view-row"><div class="property-view-label">–≠—Ç–∞–∂–Ω–æ—Å—Ç—å</div><div class="property-view-value">${property.floorsTotal}</div></div>`;
                        if (property.parking) html += `<div class="property-view-row"><div class="property-view-label">–ü–∞—Ä–∫–æ–≤–∫–∞</div><div class="property-view-value">${property.parking}</div></div>`;
                        html += `</div></div>`;
                    }
                    
                    // –°–µ–∫—Ü–∏—è "–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞"
                    if (property.heating || property.waterSupply || property.sewerage || property.gas || property.electricity || property.amenities) {
                        html += `<div class="property-view-section">
                            <div class="property-view-section-title">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ –∏ —É–¥–æ–±—Å—Ç–≤–∞</div>
                            <div class="property-view-utilities">`;
                        if (property.heating) html += `<div class="property-view-utility"><span class="property-view-utility-label">–û—Ç–æ–ø–ª–µ–Ω–∏–µ</span><span class="property-view-utility-value">${property.heating}</span></div>`;
                        if (property.waterSupply) html += `<div class="property-view-utility"><span class="property-view-utility-label">–í–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ</span><span class="property-view-utility-value">${property.waterSupply}</span></div>`;
                        if (property.sewerage) html += `<div class="property-view-utility"><span class="property-view-utility-label">–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏—è</span><span class="property-view-utility-value">${property.sewerage}</span></div>`;
                        if (property.gas) html += `<div class="property-view-utility"><span class="property-view-utility-label">–ì–∞–∑</span><span class="property-view-utility-value">${property.gas}</span></div>`;
                        if (property.electricity) html += `<div class="property-view-utility"><span class="property-view-utility-label">–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ</span><span class="property-view-utility-value">${property.electricity}</span></div>`;
                        html += `</div>`;
                        if (property.amenities) {
                            const amenitiesList = property.amenities.split(',').map(a => a.trim()).filter(a => a);
                            if (amenitiesList.length > 0) {
                                html += `<div class="property-view-amenities">`;
                                amenitiesList.forEach(amenity => {
                                    html += `<span class="property-view-amenity">${amenity}</span>`;
                                });
                                html += `</div>`;
                            }
                        }
                        html += `</div>`;
                    }
                    
                    contentEl.innerHTML = html;
                }
                
                // –û–ø–∏—Å–∞–Ω–∏–µ
                if (descriptionEl) {
                    descriptionEl.innerHTML = property.description && property.description.trim() ? property.description : '‚Äî';
                }
                
                // –ê–≤—Ç–æ—Ä
                if (authorEl) {
                    const authorName = property.authorFirstName 
                        ? `${property.authorFirstName} ${property.authorLastName || ''}`.trim()
                        : property.authorEmail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                    authorEl.innerHTML = `
                        <span>–ê–≤—Ç–æ—Ä –æ–±—ä—è–≤–ª–µ–Ω–∏—è:</span>
                        <span class="property-view-author-name">${authorName}</span>
                        ${property.isRealtor ? '<span class="property-view-author-badge">–†–∏–µ–ª—Ç–æ—Ä</span>' : ''}
                    `;
                }
                
                // –ö–Ω–æ–ø–∫–∞ —á–∞—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –Ω–µ –¥–ª—è –∞–≤—Ç–æ—Ä–∞)
                if (chatBtnEl) {
                    const currentUserEmail = document.getElementById('current-user-email')?.textContent;
                    const isOwner = currentUserEmail && property.authorEmail && currentUserEmail === property.authorEmail;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–æ–º
                    if (currentUserEmail && !isOwner) {
                        chatBtnEl.style.display = 'inline-block';
                        chatBtnEl.onclick = (e) => {
                            e.stopPropagation();
                            closePropertyView();
                            window.location.href = '/chat?propertyId=' + propertyId;
                        };
                    } else {
                        chatBtnEl.style.display = 'none';
                    }
                }
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.classList.add('open');
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
                document.body.style.overflow = 'hidden';
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', err);
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
            }
        }
        
        function closePropertyView() {
            const modal = document.getElementById('property-view-modal');
            if (modal) {
                modal.classList.remove('open');
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
                document.body.style.overflow = '';
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('property-view-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePropertyView();
                    }
                });
            }
        });
    </script>

    <script sec:authorize="isAuthenticated()">        
        async function openPropertyModal(btn){
            const m = qs('prop-modal');
            const title = qs('prop-modal-title');
            
            if (btn && btn.parentElement){
                // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API
                const d = btn.parentElement;
                const propertyId = d.getAttribute('data-id');
                
                if (propertyId) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    title.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                    m.classList.add('open');
                    document.body.style.overflow = 'hidden';
                    
                    try {
                        const res = await fetch('/v1/api/properties/' + propertyId);
                        if (!res.ok) {
                            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
                            m.classList.remove('open');
                            document.body.style.overflow = '';
                            return;
                        }
                        
                        const data = await res.json();
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ API
                        qs('f-id').value = data.id || '';
                        qs('f-type').value = data.type || '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
                        qs('f-category').value = data.category || '–í—Ç–æ—Ä–∏—á–∫–∞';
                        qs('f-address').value = data.address || '';
                        qs('f-city').value = data.city || '';
                        qs('f-district').value = data.district || '';
                        qs('f-area').value = data.area || '';
                        qs('f-rooms').value = data.rooms || '';
                        qs('f-floor').value = data.floor || '';
                        qs('f-floors').value = data.floorsTotal || '';
                        qs('f-price').value = data.price || '';
                        qs('f-images').value = data.imageUrls || '';
                        qs('f-description').value = data.description || '';
                        
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                        if (qs('f-kitchen-area')) qs('f-kitchen-area').value = data.kitchenArea || '';
                        if (qs('f-year-built')) qs('f-year-built').value = data.yearBuilt || '';
                        if (qs('f-building-material')) qs('f-building-material').value = data.buildingMaterial || '';
                        if (qs('f-condition')) qs('f-condition').value = data.condition || '';
                        if (qs('f-plot-area')) qs('f-plot-area').value = data.plotArea || '';
                        if (qs('f-land-category')) qs('f-land-category').value = data.landCategory || '';
                        if (qs('f-property-class')) qs('f-property-class').value = data.propertyClass || '';
                        if (qs('f-parking')) qs('f-parking').value = data.parking || '';
                        if (qs('f-bedrooms')) qs('f-bedrooms').value = data.bedrooms || '';
                        if (qs('f-bathrooms')) qs('f-bathrooms').value = data.bathrooms || '';
                        if (qs('f-window-view')) qs('f-window-view').value = data.windowView || '';
                        if (qs('f-furnished')) qs('f-furnished').value = data.furnished !== null && data.furnished !== undefined ? (data.furnished ? 'true' : 'false') : '';
                        if (qs('f-renovation')) qs('f-renovation').value = data.renovation || '';
                        if (qs('f-heating')) qs('f-heating').value = data.heating || '';
                        if (qs('f-water-supply')) qs('f-water-supply').value = data.waterSupply || '';
                        if (qs('f-sewerage')) qs('f-sewerage').value = data.sewerage || '';
                        if (qs('f-gas')) qs('f-gas').value = data.gas || '';
                        if (qs('f-electricity')) qs('f-electricity').value = data.electricity || '';
                        if (qs('f-amenities')) qs('f-amenities').value = data.amenities || '';
                        
                        title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                        updateFormFieldsVisibility(data.type || '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', error);
                        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', 'error');
                        m.classList.remove('open');
                        document.body.style.overflow = '';
                        return;
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç ID, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (fallback)
                    qs('f-id').value = d.getAttribute('data-id') || '';
                    qs('f-type').value = d.getAttribute('data-type') || '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
                    qs('f-category').value = d.getAttribute('data-category') || '–í—Ç–æ—Ä–∏—á–∫–∞';
                    qs('f-address').value = d.getAttribute('data-address') || '';
                    qs('f-city').value = d.getAttribute('data-city') || '';
                    qs('f-district').value = d.getAttribute('data-district') || '';
                    qs('f-area').value = d.getAttribute('data-area') || '';
                    qs('f-rooms').value = d.getAttribute('data-rooms') || '';
                    qs('f-floor').value = d.getAttribute('data-floor') || '';
                    qs('f-floors').value = d.getAttribute('data-floors') || '';
                    qs('f-price').value = d.getAttribute('data-price') || '';
                    qs('f-images').value = d.getAttribute('data-imageUrls') || '';
                    qs('f-description').value = d.getAttribute('data-description') || '';
                    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                    updateFormFieldsVisibility(d.getAttribute('data-type') || '–∫–≤–∞—Ä—Ç–∏—Ä–∞');
                }
            } else {
                // –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
                ['f-id','f-address','f-city','f-district','f-area','f-rooms','f-floor','f-floors','f-price','f-images','f-description'].forEach(i=>qs(i).value='');
                // –û—á–∏—â–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                ['f-kitchen-area','f-year-built','f-building-material','f-condition','f-plot-area','f-land-category','f-property-class','f-parking','f-bedrooms','f-bathrooms','f-window-view','f-furnished','f-renovation','f-heating','f-water-supply','f-sewerage','f-gas','f-electricity','f-amenities'].forEach(i=>{
                    const el = qs(i);
                    if (el) el.value = '';
                });
                qs('f-type').value = '–∫–≤–∞—Ä—Ç–∏—Ä–∞';
                qs('f-category').value = '–í—Ç–æ—Ä–∏—á–∫–∞';
                title.textContent = '–ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                updateFormFieldsVisibility('–∫–≤–∞—Ä—Ç–∏—Ä–∞');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π
            const typeSelect = qs('f-type');
            if (typeSelect) {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                typeSelect.onchange = null;
                typeSelect.onchange = function() {
                    updateFormFieldsVisibility(this.value);
                };
            }
            
            m.classList.add('open');
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
            document.body.style.overflow = 'hidden';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
        function updateFormFieldsVisibility(propertyType) {
            const kitchenAreaGroup = qs('f-kitchen-area-group');
            const plotAreaGroup = qs('f-plot-area-group');
            const landCategoryGroup = qs('f-land-category-group');
            const propertyClassGroup = qs('f-property-class-group');
            const bedroomsGroup = qs('f-bedrooms-group');
            const windowViewGroup = qs('f-window-view-group');
            const buildingMaterialGroup = qs('f-building-material-group');
            const floorGroup = qs('f-floor-group');
            
            if (propertyType === '–∫–≤–∞—Ä—Ç–∏—Ä–∞') {
                if (kitchenAreaGroup) kitchenAreaGroup.style.display = 'block';
                if (plotAreaGroup) plotAreaGroup.style.display = 'none';
                if (landCategoryGroup) landCategoryGroup.style.display = 'none';
                if (propertyClassGroup) propertyClassGroup.style.display = 'none';
                if (bedroomsGroup) bedroomsGroup.style.display = 'none';
                if (windowViewGroup) windowViewGroup.style.display = 'block';
                if (buildingMaterialGroup) buildingMaterialGroup.style.display = 'block';
                if (floorGroup) floorGroup.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ "–≠—Ç–∞–∂" –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä
            } else if (propertyType === '–¥–æ–º') {
                if (kitchenAreaGroup) kitchenAreaGroup.style.display = 'none';
                if (plotAreaGroup) plotAreaGroup.style.display = 'block';
                if (landCategoryGroup) landCategoryGroup.style.display = 'block';
                if (propertyClassGroup) propertyClassGroup.style.display = 'none';
                if (bedroomsGroup) bedroomsGroup.style.display = 'block';
                if (windowViewGroup) windowViewGroup.style.display = 'none';
                if (buildingMaterialGroup) buildingMaterialGroup.style.display = 'block';
                if (floorGroup) floorGroup.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ "–≠—Ç–∞–∂" –¥–ª—è –¥–æ–º–æ–≤
            } else if (propertyType === '–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è') {
                if (kitchenAreaGroup) kitchenAreaGroup.style.display = 'none';
                if (plotAreaGroup) plotAreaGroup.style.display = 'none';
                if (landCategoryGroup) landCategoryGroup.style.display = 'none';
                if (propertyClassGroup) propertyClassGroup.style.display = 'block';
                if (bedroomsGroup) bedroomsGroup.style.display = 'none';
                if (windowViewGroup) windowViewGroup.style.display = 'none';
                if (buildingMaterialGroup) buildingMaterialGroup.style.display = 'block';
                if (floorGroup) floorGroup.style.display = 'block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ "–≠—Ç–∞–∂" –¥–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
            }
        }
        
        function closePropertyModal(){ 
            const m = qs('prop-modal');
            if (m) {
                m.classList.remove('open');
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω–∞
                document.body.style.overflow = '';
            }
        }
        function clearErrors(){
            ['type','category','address','city','district','area','rooms','floor','floors','price']
                .forEach(k=>{ const el = qs('e-'+k); if (el) { el.style.display='none'; el.textContent=''; }});
        }
        function validate(){
            clearErrors();
            let ok = true;
            function err(id,msg){ const el = qs('e-'+id); if(el){ el.textContent = msg; el.style.display='block'; } ok=false; }
            if (!qs('f-address').value.trim()) err('address','–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å');
            if (!qs('f-city').value.trim()) err('city','–£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥');
            const area = parseFloat(qs('f-area').value||0); if (!(area>0)) err('area','–ü–ª–æ—â–∞–¥—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0');
            const price = parseFloat(qs('f-price').value||0); if (!(price>0)) err('price','–¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 0');
            return ok;
        }
        async function saveProperty(){
            if (!validate()) { showToast('–ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ', 'error'); return; }
            try {
                const id = qs('f-id').value;
                // –û—á–∏—â–∞–µ–º imageUrls –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                let imageUrlsValue = qs('f-images').value || '';
                if (imageUrlsValue) {
                    // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π, —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ
                    const urls = imageUrlsValue.split(',')
                        .map(url => url.trim())
                        .filter(url => url.length > 0);
                    imageUrlsValue = urls.join(',');
                }
                
                const payload = {
                    type: qs('f-type').value,
                    category: qs('f-category').value,
                    address: qs('f-address').value,
                    city: qs('f-city').value,
                    district: qs('f-district').value || '',
                    area: parseFloat(qs('f-area').value||0),
                    rooms: qs('f-rooms').value ? parseInt(qs('f-rooms').value) : null,
                    floor: (qs('f-floor-group') && qs('f-floor-group').style.display !== 'none' && qs('f-floor').value) ? parseInt(qs('f-floor').value) : null,
                    floorsTotal: qs('f-floors').value ? parseInt(qs('f-floors').value) : null,
                    price: parseFloat(qs('f-price').value||0),
                    imageUrls: imageUrlsValue,
                    description: qs('f-description').value || '',
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                    kitchenArea: qs('f-kitchen-area') && qs('f-kitchen-area').value ? parseFloat(qs('f-kitchen-area').value) : null,
                    yearBuilt: qs('f-year-built') && qs('f-year-built').value ? parseInt(qs('f-year-built').value) : null,
                    buildingMaterial: qs('f-building-material') && qs('f-building-material').value ? qs('f-building-material').value : null,
                    condition: qs('f-condition') && qs('f-condition').value ? qs('f-condition').value : null,
                    plotArea: qs('f-plot-area') && qs('f-plot-area').value ? parseFloat(qs('f-plot-area').value) : null,
                    landCategory: qs('f-land-category') && qs('f-land-category').value ? qs('f-land-category').value : null,
                    propertyClass: qs('f-property-class') && qs('f-property-class').value ? qs('f-property-class').value : null,
                    parking: qs('f-parking') && qs('f-parking').value ? qs('f-parking').value : null,
                    bedrooms: qs('f-bedrooms') && qs('f-bedrooms').value ? parseInt(qs('f-bedrooms').value) : null,
                    bathrooms: qs('f-bathrooms') && qs('f-bathrooms').value ? parseInt(qs('f-bathrooms').value) : null,
                    windowView: qs('f-window-view') && qs('f-window-view').value ? qs('f-window-view').value : null,
                    furnished: qs('f-furnished') && qs('f-furnished').value ? qs('f-furnished').value === 'true' : null,
                    renovation: qs('f-renovation') && qs('f-renovation').value ? qs('f-renovation').value : null,
                    heating: qs('f-heating') && qs('f-heating').value ? qs('f-heating').value : null,
                    waterSupply: qs('f-water-supply') && qs('f-water-supply').value ? qs('f-water-supply').value : null,
                    sewerage: qs('f-sewerage') && qs('f-sewerage').value ? qs('f-sewerage').value : null,
                    gas: qs('f-gas') && qs('f-gas').value ? qs('f-gas').value : null,
                    electricity: qs('f-electricity') && qs('f-electricity').value ? qs('f-electricity').value : null,
                    amenities: qs('f-amenities') && qs('f-amenities').value ? qs('f-amenities').value : null
                };
                
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:', payload);
                
                const url = id ? `/v1/api/properties/${id}` : '/v1/api/properties';
                const method = id ? 'PUT' : 'POST';
                const res = await fetch(url, { 
                    method, 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });
                
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', res.status, res.statusText);
                
                if (!res.ok) {
                    let errorText = '';
                    try {
                        errorText = await res.text();
                    } catch (e) {
                        errorText = '–û—à–∏–±–∫–∞ ' + res.status;
                    }
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', errorText);
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + (errorText || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'), 'error');
                    return;
                }
                
                // –ü—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è
                let data = null;
                try {
                    const contentType = res.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const responseText = await res.text();
                        if (responseText && responseText.trim().length > 0) {
                            data = JSON.parse(responseText);
                            console.log('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:', data);
                        }
                    }
                } catch (parseError) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ):', parseError);
                }
                showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
                closePropertyModal();
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', e);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + e.message, 'error');
            }
        }
        async function deleteProperty(btn){
            const id = btn.parentElement.getAttribute('data-id');
            if (!id) return;
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
            const res = await fetch(`/v1/api/properties/${id}`, { method: 'DELETE' });
            if (!res.ok) { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å', 'error'); return; }
            showToast('–£–¥–∞–ª–µ–Ω–æ', 'success');
            location.reload();
        }
        async function togglePromote(propertyId, buttonElement){
            try {
                const isPromoted = buttonElement.textContent.trim() === '–°–Ω—è—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ';
                const endpoint = isPromoted ? `/v1/api/properties/${propertyId}/unpromote` : `/v1/api/properties/${propertyId}/promote`;
                const res = await fetch(endpoint, { method: 'POST' });
                if (!res.ok) { showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ', 'error'); return; }
                showToast(isPromoted ? '–ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —Å–Ω—è—Ç–æ' : '–û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ', 'success');
                buttonElement.textContent = isPromoted ? '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—å' : '–°–Ω—è—Ç—å –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ';
                buttonElement.classList.toggle('promoted-btn');
                setTimeout(() => location.reload(), 500);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è:', e);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è', 'error');
            }
        }
        async function uploadImages(){
            const filesInput = qs('f-files');
            const statusEl = document.getElementById('upload-status');
            if (!filesInput || !filesInput.files || filesInput.files.length === 0) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã', 'error'); return; }
            const fd = new FormData();
            Array.from(filesInput.files).forEach(f => fd.append('files', f));
            statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            try {
                const res = await fetch('/v1/api/uploads/images', { method: 'POST', body: fd });
                if (!res.ok) { showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error'); statusEl.textContent=''; return; }
                const urls = await res.json();
                const current = qs('f-images').value.trim();
                const appended = urls.join(',');
                qs('f-images').value = current ? (current + ',' + appended) : appended;
                statusEl.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ' + urls.length;
                showToast('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
            } catch (e) {
                showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ', 'error');
                statusEl.textContent='';
            }
        }
    </script>
<script src="/js/hotkeys.js"></script>
</body>
</html>
